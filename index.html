<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
  <title>Money Tracker</title>

  <!-- 3rd party libs -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://eqblphvyqfibxhrtniwq.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxYmxwaHZ5cWZpYnhocnRuaXdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MzcwOTUsImV4cCI6MjA3MzQxMzA5NX0.QaTyuEstLGI3ISGli9ykWwmowSDKCXjiHn6xOf1oKEw";
  </script>
  <style>
    :root{
      --bg:#e9eef5; --panel:#f7f9fc; --ink:#1e2330; --muted:#57637a; --border:#c8d3e5;
      --good:#189a52; --warn:#e19b24; --bad:#d84b4b;

      /* section colors */
      --grocery1:#b6e8cf; --grocery2:#94dbbd;
      --reimb1:#ffd29a;  --reimb2:#ffbf70;
      --wages1:#c9b6ff;  --wages2:#b39aff;
      --family1:#ffb3ce; --family2:#ff9fc3;

      --scale:0.70;
      --app-header-top:#3388ff;
      --app-header-bot:#2270ee;
      --app-header-border:#1d5fd1;

      --row-h: 36px;
      --header-h: 44px;
    }

    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      font-size:calc(16px * var(--scale));
    }

    /* ---------- AUTH VIEW ---------- */
    .auth-wrap{ min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px; }
    .auth-card{
      width:min(92vw,480px);
      background:linear-gradient(180deg,#f7f9fc,#eef3fb);
      border:1px solid var(--border); border-radius:16px; padding:18px;
      box-shadow:0 10px 26px rgba(0,0,0,.12);
    }
    .auth-card h1{ margin:0 0 10px; font-size:1.4rem; }
    .auth-card p{ margin:0 0 14px; color:var(--muted); }
    .auth-grid{ display:grid; grid-template-columns:1fr; gap:10px; }
    .auth-actions{ display:flex; gap:10px; margin-top:6px; align-items:center; }
    .auth-msg{ min-height:20px; font-size:.95rem; color:var(--bad); }
    .link-btn{ background:transparent; border:none; color:#194BFB; font-weight:700; cursor:pointer; padding:0; }
    .remember-wrap{ display:flex; align-items:center; gap:6px; margin-top:4px; }
    .remember-wrap input{ width:auto; }

    header{
      position:sticky; top:0; z-index:100;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:10px 12px;
      background:linear-gradient(180deg, var(--app-header-top), var(--app-header-bot));
      border-bottom:1px solid var(--app-header-border);
      color:#000;
    }
    .title-section{display:flex; flex-direction:column; align-items:flex-start; justify-content:center;}
    .title{font-weight:800; font-size:calc(1.4rem * var(--scale)); color:#000; line-height:1.2; display:flex; align-items:center;}
    .version{font-size:calc(0.9rem * var(--scale)); color:#ffffff; font-weight:bold; margin-left:8px; background:#e74c3c; padding:3px 8px; border-radius:6px; text-shadow:0 1px 2px rgba(0,0,0,0.3); flex-shrink:0;}
    .header-right{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    
    /* Connection status indicator */
    .connection-status {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.8em;
      font-weight: 600;
      background: #ff6b6b;
      color: white;
      border: 1px solid #ff5252;
    }
    .connection-status.online {
      background: #51cf66;
      color: white;
      border-color: #40c057;
    }
    .connection-status.connecting {
      background: #ffd43b;
      color: #495057;
      border-color: #fab005;
    }
    #langSwitch{
      background:rgba(255,255,255,.8); color:#000; border:1px solid rgba(0,0,0,.25);
      border-radius:10px; padding:6px 10px; font-size:calc(.9rem * var(--scale)); width:60px;
    }

    .mini-btn{
      background:#eef2f9; border:1px solid var(--border); color:#000;
      padding:6px 8px; border-radius:8px; font-weight:700; cursor:pointer;
      font-size:calc(.9rem * var(--scale)); line-height:1
    }
    .font-zoom{display:flex; align-items:center; gap:6px}
    #fsSlider{width:50px; height:16px; background:transparent; -webkit-appearance:none;}
    #fsSlider:focus{outline:none}
    #fsSlider::-webkit-slider-runnable-track{height:4px; background:#cad6f2; border-radius:999px}
    #fsSlider::-webkit-slider-thumb{
      -webkit-appearance:none; width:12px; height:12px; margin-top:-4px;
      background:#f0f4ff; border-radius:50%; border:1px solid #b9c7ea
    }

    .container{max-width:100%; width:100%; margin:0 auto; padding:12px}

    .card{
      border:1px solid var(--border); border-radius:16px; padding:12px; margin-bottom:14px;
      box-shadow:0 6px 18px rgba(26,38,63,.06)
    }
    .card.grocery{  background:linear-gradient(180deg,var(--grocery1),var(--grocery2)); }
    .card.reimb{    background:linear-gradient(180deg,var(--reimb1),var(--reimb2)); }
    .card.wages{    background:linear-gradient(180deg,var(--wages1),var(--wages2)); }
    .card.family{   background:linear-gradient(180deg,var(--family1),var(--family2)); }

    .card-header{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px}
    .modal .card-header{justify-content:center; position:relative;}
    .modal .card-header .actions{position:absolute; right:0;}
    .card-title{display:flex; align-items:center; gap:10px; font-weight:800; color:#000}
    .accent-dot{width:10px; height:10px; border-radius:50%}
    .grocery .accent-dot{background:#10b981}
    .reimb   .accent-dot{background:#f59e0b}
    .wages   .accent-dot{background:#8b5cf6}
    .family  .accent-dot{background:#f472b6}

    .actions{display:flex; gap:6px; align-items:center; flex-wrap:wrap; justify-content:flex-end}

    .btn{
      background:#eef2f9; border:1px solid var(--border); color:var(--ink);
      padding:6px 10px; border-radius:10px; font-weight:700; cursor:pointer;
      font-size:calc(.95rem * var(--scale)); transition:transform .06s ease;
    }
    .btn:hover{background:#e9eef5;} .btn:active{opacity:.95;}
    .btn.good{background:#e6f3ee; border-color:#cfe7db; color:#0e8f42}
    .btn.warn{background:#ff8c00; border-color:#e67300; color:#fff}
    .btn.warn:hover{background:#e67300;}
    .btn.sm{padding:4px 8px; font-size:calc(.9rem * var(--scale))}
    .icon-btn{ background:#eef2f9; border:1px solid var(--border); color:#000;
      width:28px; height:28px; border-radius:7px; display:inline-grid; place-items:center;
      cursor:pointer; transition:background .15s ease, opacity .1s ease;
    }
    .icon-btn:hover{background:#e9eef5;}

    .kpi-grid{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
    .stat{background:#f4f7fb; border:1px solid var(--border); border-radius:12px; padding:10px; display:flex; flex-direction:column; gap:4px; min-height:76px}
    .stat .label{color:var(--muted); font-size:calc(.85rem * var(--scale)); line-height:1.1}
    .stat .label .short{display:none}
    .stat .value{font-weight:900; font-size:calc(1.2rem * var(--scale))}
    @media(max-width:520px){ .stat .label .full{display:none} .stat .label .short{display:inline} }

    .sheet-viewport{
      border:1px solid var(--border);
      border-radius:12px;
      overflow:auto;
      background:#fbfcff;
      min-height: calc(var(--header-h) + (var(--row-h) * 3));
      max-height: calc(var(--header-h) + (var(--row-h) * 4));
    }
    .sheet-viewport::-webkit-scrollbar{ 
      width: 8px; 
      height: 8px; 
    }
    .sheet-viewport::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    .sheet-viewport::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }
    .sheet-viewport::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }

    table{ width:100%; border-collapse:collapse; background:#fbfcff; table-layout:auto; }

    thead{
      position:sticky; top:0; z-index:1;
      background:#e5e7eb; border-bottom:1px solid #cbd5e1;
      height:var(--header-h);
    }
    thead th{
      color:#000; text-align:left; font-weight:800;
      padding:8px 10px; white-space:nowrap; height:var(--header-h);
    }

    tbody td{
      padding:6px 10px; line-height:1.2; vertical-align:middle;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      border-bottom:1px solid #d1d5db; color:var(--ink);
      height:var(--row-h);
    }
    tbody tr:nth-child(even){ background:#f3f4f6; }
    tbody tr:hover{ background:#e5e7eb; }
    tbody tr[data-has-attachment="true"]{ cursor:pointer; }

    td.actions-cell{ white-space:nowrap; text-align:left; }

    header .title{ color:#000; }

    .placeholder-row td{
      color:#7583a0; font-style:italic; text-align:center; padding:10px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      background:#f8fafc; border-bottom:1px solid #cbd5e1;
    }

    .card-title{ font-size:15px; font-weight:900; color:#000; }
    .card-title .section-total{ margin-left:8px; font-weight:900; }

    input,select{
      width:100%; background:#ffffff; color:var(--ink); border:1px solid var(--border);
      padding:8px 10px; border-radius:10px; font-size:calc(1rem * var(--scale))
    }
    
    /* Improve mobile dropdown behavior */
    select {
      touch-action: manipulation;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      cursor: pointer;
    }
    
    /* Add custom dropdown arrow */
    select {
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 8px center;
      background-size: 16px;
      padding-right: 32px;
    }
    
    input[type="date"] { text-align: left; }
    input::placeholder{color:#8391ab}

    .modal{position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:9999; backdrop-filter:blur(4px); -webkit-backdrop-filter:blur(4px);}
    .modal.open{display:flex}
    .modal.open ~ .container, .modal.open ~ header { filter:blur(2px); pointer-events:none; }
    
    /* When any modal is open, blur the background content */
    body:has(.modal.open) .container,
    body:has(.modal.open) header {
      filter: blur(2px);
      pointer-events: none;
    }
    .panel{
      width:auto; min-width:400px; max-width:min(92vw,560px); background:linear-gradient(180deg,#f7f9fc,#eef3fb);
      border:1px solid var(--border); border-radius:16px; padding:14px; box-shadow:0 10px 26px rgba(0,0,0,.2)
    }
    
    /* Mobile responsive modal panels */
    @media(max-width:600px){
      .panel{
        min-width:280px;
        max-width:95vw;
        padding:12px;
        margin:8px;
      }
    }
    .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:10px}
    .grid>div{grid-column:span 12} @media(min-width:640px){.grid>div{grid-column:span 6}}
    
    /* 2-column form layout */
    .form-grid{display:grid; grid-template-columns:auto 1fr; gap:8px 12px; align-items:center; max-width:400px; margin:0 auto; justify-self:center;}
    .form-grid label{display:flex; align-items:center; gap:8px; font-weight:600; margin:0; justify-content:flex-end; text-align:right;}
    .form-grid input, .form-grid select{width:200px; max-width:200px;}
    .form-grid .full-width{grid-column:1 / -1;}
    .form-grid .full-width input{width:100%; max-width:100%;}
    .form-grid .upload-btn{justify-self:start; width:auto; max-width:none;}
    
    /* Mobile responsive form layout */
    @media(max-width:600px){
      .form-grid{
        grid-template-columns:1fr;
        max-width:300px;
        gap:6px;
        padding:0 16px;
      }
      .form-grid label{
        justify-content:flex-start;
        text-align:left;
        font-size:0.9em;
      }
      .form-grid input, .form-grid select{
        width:100%;
        max-width:100%;
      }
    }

    /* Loading styles */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    .loading-overlay.loading-active {
      display: flex;
    }
    .loading-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 20px;
      margin: auto;
    }
    
    /* Mobile-specific loading positioning */
    @media(max-width:600px){
      .loading-overlay {
        /* Ensure it covers the entire viewport on mobile */
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100vw;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .loading-content {
        position: relative;
        transform: none;
        margin: 0;
        padding: 16px;
      }
    }
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-text {
      color: white;
      margin-top: 15px;
      font-size: calc(1rem * var(--scale));
      text-align: center;
      font-weight: 500;
    }
    .btn.loading {
      position: relative;
      pointer-events: none;
      opacity: 0.7;
    }
    .btn.loading:after {
      content: "";
      position: absolute;
      width: 16px;
      height: 16px;
      margin: auto;
      border: 2px solid transparent;
      border-top-color: #ffffff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    @keyframes shake{ 0%{transform:translateX(0)} 20%{transform:translateX(-5px)} 40%{transform:translateX(5px)} 60%{transform:translateX(-5px)} 80%{transform:translateX(5px)} 100%{transform:translateX(0)} }
    .mandatory-missing{border:2px solid var(--bad)!important; animation:shake .3s ease-in-out 0s 2; box-shadow:0 0 0 3px rgba(216,75,75,.08)}

    /* Error notification styles */
    .error-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #ff4444;
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
      font-weight: 500;
      max-width: 300px;
      animation: slideIn 0.3s ease-out;
    }
    .error-notification.hide {
      animation: slideOut 0.3s ease-in forwards;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }

    /* Modal blocking overlay during processing */
    .modal.processing {
      pointer-events: none;
    }
    .modal.processing .panel {
      opacity: 0.8;
    }
    .header-filters{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin:8px 0 14px; }
    .header-filters .filter-label{ font-weight:800; color:var(--ink); }
    .header-filters input[type="date"]{ width:auto; min-width:9.5ch; padding:6px 8px; font-size:calc(.95rem * var(--scale)); }
    .header-filters .arrow{ opacity:.7; }
    .header-filters .clear-btn{ background:#eef2f9; border:1px solid var(--border); color:#000; }
    .version-badge{ font-size:calc(0.75rem * var(--scale)); color:#ffffff; font-weight:bold; background:#e74c3c; padding:2px 6px; border-radius:4px; text-shadow:0 1px 1px rgba(0,0,0,0.3); margin-left:auto; }

    /* Delete modal styles */
    .delete-modal-panel {
      min-width: 400px;
      max-width: 600px;
      width: auto;
    }
    .delete-modal-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 16px;
      padding: 8px 0;
    }
    .delete-modal-content p {
      margin: 0;
      color: var(--ink);
      font-size: 1.1em;
    }
    .delete-row-details {
      background: #f8fafc;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 8px;
      width: auto;
      max-width: 500px;
      min-width: 200px;
      display: none;
      text-align: left;
    }
    .delete-row-data {
      font-family: monospace;
      font-size: 1.1em;
      color: var(--muted);
      word-wrap: break-word;
      white-space: pre-wrap;
      line-height: 1.2;
      margin: 0;
      padding: 0;
      height: auto;
      min-height: 0;
      width: auto;
      display: inline-block;
    }
    .delete-modal-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 8px;
    }
    .delete-modal-actions .btn.warn {
      background: #e74c3c;
      color: #000;
      border: 1px solid #c0392b;
    }
    .delete-modal-actions .btn.warn:hover {
      background: #c0392b;
      color: #000;
    }
    .btn.good {
      background: #27ae60;
      color: #000;
      border: 1px solid #229954;
    }
    .btn.good:hover {
      background: #229954;
      color: #000;
    }
    
    /* Processing states */
    .btn.processing {
      opacity: 0.7;
      pointer-events: none;
      position: relative;
    }
    .btn.processing::after {
      content: "";
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top: 2px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    
    /* Error notification */
    .error-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #e74c3c;
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 10000;
      max-width: 300px;
      font-size: 14px;
      line-height: 1.4;
      transform: translateX(100%);
      opacity: 0;
      transition: all 0.3s ease;
    }
    .error-notification.show {
      transform: translateX(0);
      opacity: 1;
    }
    .error-notification .retry-btn {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 8px;
      font-size: 12px;
      display: block;
      width: 100%;
    }
    .error-notification .retry-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    /* Row highlight animation */
    .row-highlight {
      animation: flashHighlight 2s ease-in-out;
    }
    @keyframes flashHighlight {
      0% { background-color: transparent; }
      25% { background-color: #ffff00; opacity: 0.9; }
      50% { background-color: transparent; }
      75% { background-color: #ffff00; opacity: 0.7; }
      100% { background-color: transparent; }
    }
    
    /* Empty placeholder rows styling */
    .empty-row {
      opacity: 0.5;
      height: var(--row-h);
    }
    .empty-row td {
      height: var(--row-h);
      color: #ccc;
      text-align: center;
    }
    .empty-row:hover {
      opacity: 0.7;
      background-color: #f8f9fa;
    }
    .placeholder-row {
      height: var(--row-h);
    }
    .placeholder-row td {
      height: var(--row-h);
    }
  </style>
</head>
<body>
  <!-- AUTH VIEW -->
  <div id="authView" class="auth-wrap" style="display:flex">
    <div class="auth-card">
      <h1>Sign in</h1>
      <p>Use your email and password to access your data.</p>
      
      <!-- Multi-device warning -->
      <div id="multiDeviceWarning" style="background:#fff3cd; border:1px solid #ffeaa7; border-radius:8px; padding:10px; margin:10px 0; font-size:0.9em;">
        ⚠️ Notice: Using the same login on multiple devices simultaneously may cause data synchronization issues. Please sign out from other devices before logging in here.
      </div>
      
      <form id="authLoginForm" class="auth-grid">
        <div>
          <label>Email
            <input id="authEmail" type="email" placeholder="you@example.com" required>
          </label>
        </div>
        <div>
          <label>Password
            <input id="authPassword" type="password" placeholder="••••••••" required>
          </label>
        </div>

        <div class="remember-wrap">
          <input id="rememberMe" type="checkbox">
          <label for="rememberMe" style="margin:0;cursor:pointer">Remember me</label>
        </div>

        <div class="auth-actions">
          <button type="submit" class="btn good">Sign in</button>
          <button type="button" id="authCreateBtn" class="btn">Create account</button>
        </div>
        <div id="authMsg" class="auth-msg"></div>
      </form>
    </div>
  </div>

  <!-- APP VIEW -->
  <div id="appView" style="display:none">
    <header>
      <div class="title-section">
        <div class="title" id="appTitle">Money Tracker</div>
      </div>
      <div class="header-right">
        <input type="file" id="importExcel" accept=".xlsx,.xls" style="display:none">
        <button class="mini-btn" id="exportExcel" style="display:none">⬇ Export</button>
        <button class="mini-btn" id="importBtn" style="display:none">⬆ Import</button>

        <div class="font-zoom">
          <button id="fsDown" class="mini-btn" title="Smaller">A−</button>
          <input id="fsSlider" type="range" min="60" max="200" value="70" step="5" />
          <button id="fsUp" class="mini-btn" title="Larger">A+</button>
        </div>

        <select id="langSwitch">
          <option value="en">EN</option>
          <option value="vi">VN</option>
        </select>

        <div id="connectionStatus" class="connection-status" style="display:none;">
          <span id="connectionIcon">🌐</span>
          <span id="connectionText">Offline</span>
        </div>

        <button class="mini-btn" id="signOutBtn" title="Sign out">Sign out</button>
      </div>
    </header>

    <div class="container">
      <!-- KPI BAR -->
      <section class="card" id="kpiCard" style="background:linear-gradient(180deg,#f7f9fc,#eef3fb)">
        <div class="kpi-grid">
          <div class="stat"><div class="label" title="Total Family"><span class="full" id="kpiReceiptsLabel">Total Family</span><span class="short">Family</span></div><div class="value" id="kCount">0</div></div>
          <div class="stat"><div class="label" title="Total Expense"><span class="full" id="kpiExpLabel">Total Expense</span><span class="short">Expense</span></div><div class="value" id="kExp">0</div></div>
          <div class="stat"><div class="label" title="Total Reimbursed"><span class="full" id="kpiReimbLabel">Total Reimbursed</span><span class="short">Reimb.</span></div><div class="value" id="kReimb">0</div></div>
          <div class="stat"><div class="label" title="Total Wages"><span class="full" id="kpiWagesLabel">Total Wages</span><span class="short">Wages</span></div><div class="value" id="kWages">0</div></div>
        </div>
      </section>

      <!-- Date filter -->
      <div class="header-filters" role="region" aria-label="Date filter">
        <span class="filter-label" id="filterLabel">Filter</span>
        <input type="date" id="filterStart" title="Start date">
        <span class="arrow">→</span>
        <input type="date" id="filterEnd" title="End date">
        <button class="mini-btn clear-btn" id="clearDateFilter" type="button">Clear</button>
        <span class="version-badge">v3.7</span>
      </div>

      <!-- WORK -->
      <section class="card grocery">
        <div class="card-header">
          <div class="card-title">
            <span class="accent-dot"></span>
            <span id="groceryTitle">Work Transactions</span>
            <span class="section-total" id="groceryTotal">0</span>
          </div>
          <div class="actions">
            <button class="btn good sm" id="btnEnterReceipt" title="Add Receipt">Add</button>
          </div>
        </div>
        <div class="sheet-viewport">
          <table>
            <thead><tr id="groceryHead"></tr></thead>
            <tbody id="reimbBody"></tbody>
          </table>
        </div>
      </section>

      <!-- REIMBURSEMENT -->
      <section class="card reimb">
        <div class="card-header">
          <div class="card-title">
            <span class="accent-dot"></span>
            <span id="reimbTitle">Reimbursement</span>
            <span class="section-total" id="reimbOnlyTotal">0</span>
          </div>
          <div class="actions">
            <button class="btn good sm" id="addReimbOnlyRow" title="Add Reimbursement">Add</button>
          </div>
        </div>
        <div class="sheet-viewport">
          <table>
            <thead><tr id="reimbHead"></tr></thead>
            <tbody id="reimbOnlyBody"></tbody>
          </table>
        </div>
      </section>

      <!-- WAGES -->
      <section class="card wages">
        <div class="card-header">
          <div class="card-title">
            <span class="accent-dot"></span>
            <span id="wagesTitle">Wages</span>
            <span class="section-total" id="wagesTotal">0</span>
          </div>
          <div class="actions">
            <button class="btn good sm" id="addWageRow" title="Add Wage">Add</button>
          </div>
        </div>
        <div class="sheet-viewport">
          <table>
            <thead><tr id="wagesHead"></tr></thead>
            <tbody id="wagesBody"></tbody>
          </table>
        </div>
      </section>

      <!-- FAMILY -->
      <section class="card family">
        <div class="card-header">
          <div class="card-title">
            <span class="accent-dot"></span>
            <span id="familyTitle">Family Transactions</span>
            <span class="section-total" id="homeTotal">0</span>
          </div>
          <div class="actions">
            <button class="btn good sm" id="addFamilyRow" title="Add Family Transaction">Add</button>
          </div>
        </div>
        <div class="sheet-viewport">
          <table>
            <thead><tr id="homeHead"></tr></thead>
            <tbody id="homeBody"></tbody>
          </table>
        </div>
      </section>
    </div>
  </div>

  <!-- MODALS -->
  <!-- Wages Modal -->
  <div class="modal" id="wagesModal">
    <div class="panel">
      <div class="card-header">
        <div class="card-title"><span class="accent-dot wages"></span><strong id="wagesModalTitle">Enter Your Wage</strong></div>
        <div class="actions"><button class="btn warn sm" id="closeWagesModal">✕</button></div>
      </div>
      <div class="form-grid">
        <label id="lblWDate">Date</label>
        <input id="wDate" type="date">
        
        <label id="lblWHours">Hours</label>
        <input id="wHours" type="number" step="0.01" min="0">
        
        <label id="lblWAmount">Wage Amount</label>
        <input id="wAmount" type="number" step="0.01" min="0">
        
        <label id="lblWMethod">Method</label>
        <select id="wMethod">
          <option>Cash</option><option>Check</option><option>Zelle</option><option>Other</option>
        </select>
        
        <label id="lblWNotes">Notes</label>
        <input id="wNotes" type="text">
      </div>
      <div class="actions" style="justify-content:center;margin-top:8px">
        <button class="btn good" id="addWagesRow" style="font-size:calc(1.1rem * var(--scale));padding:10px 20px;min-width:120px;">Submit</button>
      </div>
    </div>
  </div>

  <!-- Work/Grocery Modal -->
  <div class="modal" id="receiptModal">
    <div class="panel">
      <div class="card-header">
        <div class="card-title"><span class="accent-dot grocery"></span><strong id="groceryModalTitle">Enter New Receipt</strong></div>
        <div class="actions"><button class="btn warn sm" id="closeReceiptModal">✕</button></div>
      </div>
      <div class="form-grid">
        <label id="lblGDate">Date</label>
        <input id="gDate" type="date">
        
        <label id="lblGVendor">Store</label>
        <select id="gVendor">
          <option value="">Select Store...</option>
          <option value="A Dong">A Dong</option>
          <option value="ABC">ABC</option>
          <option value="Costco">Costco</option>
          <option value="Da Lat">Da Lat</option>
          <option value="Gas">Gas</option>
          <option value="Home Depot">Home Depot</option>
          <option value="Jons">Jons</option>
          <option value="Saigon">Saigon</option>
          <option value="T&K">T&K</option>
          <option value="Target">Target</option>
          <option value="Westminster">Westminster</option>
        </select>
        
        <label id="lblGTotal">Total</label>
        <input id="gTotal" type="number" step="0.01">
        
        <label id="lblGMethod">Method</label>
        <select id="gPayMethod">
          <option>Credit Card</option><option>Debit Card</option><option>Cash</option><option>Check</option><option>Other</option>
        </select>
        
        <label id="lblGCard">Last 4</label>
        <select id="gCardLast4">
          <option value="">Select...</option>
          <option value="8208">8208</option>
          <option value="7443">7443</option>
          <option value="6514">6514</option>
        </select>
        
        <label id="lblGNotes">Notes</label>
        <input id="gNotes" type="text">
      </div>
      <div style="margin-top:8px;padding:0 10px;text-align:center;">
        <input type="file" id="receiptFile" accept="image/*" style="display:none">
        <button class="btn upload-btn" id="attachReceiptBtn">📎 Upload</button>
      </div>
      <div class="actions" style="justify-content:center;margin-top:8px">
        <button class="btn good" id="addReceipt" style="font-size:calc(1.1rem * var(--scale));padding:10px 20px;min-width:120px;">Submit</button>
      </div>
    </div>
  </div>

  <!-- Reimbursement Modal -->
  <div class="modal" id="reimbOnlyModal">
    <div class="panel">
      <div class="card-header">
        <div class="card-title"><span class="accent-dot reimb"></span><strong id="reimbModalTitle">Enter Your Reimbursement</strong></div>
        <div class="actions"><button class="btn warn sm" id="closeReimbOnlyModal">✕</button></div>
      </div>
      <div class="form-grid">
        <label id="lblRDate">Date</label>
        <input id="rDate" type="date">
        
        <label id="lblRAmount">Amount</label>
        <input id="rAmount" type="number" step="0.01">
        
        <label id="lblRMethod">Method</label>
        <select id="rMethod">
          <option>Cash</option><option>Check</option><option>Zelle</option><option>Other</option>
        </select>
        
        <label id="lblRNotes">Notes</label>
        <input id="rNotes" type="text">
      </div>
      <div class="actions" style="justify-content:center;margin-top:8px">
        <button class="btn good" id="addReimbOnlyRowSubmit" style="font-size:calc(1.1rem * var(--scale));padding:10px 20px;min-width:120px;">Submit</button>
      </div>
    </div>
  </div>

  <!-- Family Modal -->
  <div class="modal" id="familyModal">
    <div class="panel">
      <div class="card-header">
        <div class="card-title"><span class="accent-dot family"></span><strong id="familyModalTitle">Enter Family Transaction</strong></div>
        <div class="actions"><button class="btn warn sm" id="closeFamilyModal">✕</button></div>
      </div>
      <div class="form-grid">
        <label id="lblFDate">Date</label>
        <input id="fDate" type="date">
        
        <label id="lblFVendor">Store</label>
        <select id="fVendor">
          <option value="">Select Store...</option>
          <option value="A Dong">A Dong</option>
          <option value="ABC">ABC</option>
          <option value="Costco">Costco</option>
          <option value="Da Lat">Da Lat</option>
          <option value="Gas">Gas</option>
          <option value="Home Depot">Home Depot</option>
          <option value="Jons">Jons</option>
          <option value="Saigon">Saigon</option>
          <option value="T&K">T&K</option>
          <option value="Target">Target</option>
          <option value="Westminster">Westminster</option>
        </select>
        
        <label id="lblFTotal">Total</label>
        <input id="fTotal" type="number" step="0.01">
        
        <label id="lblFMethod">Method</label>
        <select id="fPayMethod">
          <option>Credit Card</option><option>Debit Card</option><option>Cash</option><option>Check</option><option>Other</option>
        </select>
        
        <label id="lblFCard">Last 4</label>
        <select id="fCardLast4">
          <option value="">Select...</option>
          <option value="8208">8208</option>
          <option value="7443">7443</option>
          <option value="6514">6514</option>
        </select>
        
        <label id="lblFNotes">Notes</label>
        <input id="fNotes" type="text">
      </div>
      <div style="margin-top:8px;padding:0 10px;text-align:center;">
        <input type="file" id="familyFile" accept="image/*" style="display:none">
        <button class="btn upload-btn" id="attachFamilyBtn">📎 Upload</button>
      </div>
      <div class="actions" style="justify-content:center;margin-top:8px">
        <button class="btn good" id="addFamilySubmit" style="font-size:calc(1.1rem * var(--scale));padding:10px 20px;min-width:120px;">Submit</button>
      </div>
    </div>
  </div>

  <!-- Attachment preview -->
  <div class="modal" id="receiptPreviewModal" aria-modal="true" role="dialog">
    <div class="panel" style="max-width:92vw">
      <div class="card-header">
        <div class="card-title"><span class="accent-dot grocery"></span><strong id="receiptAttachTitle">Receipt Attachment</strong></div>
        <div class="actions"><button class="btn warn sm" id="closePreviewModal" aria-label="Close preview">✕</button></div>
      </div>
      <div style="text-align:center">
        <img id="previewImg" src="" alt="Receipt Image" style="max-width:100%; max-height:70vh; border-radius:10px;"/>
      </div>
    </div>
  </div>

  <!-- Loading overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text" id="loadingText">Processing...</div>
    </div>
  </div>

<script>
/* ===== Supabase init ===== */
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let storageChecked = false;

/* ===== Shortcuts & State ===== */
const $ = s => document.querySelector(s);
const byId = (id) => document.getElementById(id);
const setText = (id, val) => { const el = byId(id); if (el) el.textContent = String(val); };

let wagesRows = [], reimbRows = [], reimbOnlyRows = [], homeRows = [];
const KEY_WAGES="wagesRows_v1", KEY_REIMB="reimbRows_v1", KEY_REIMBONLY="reimbOnlyRows_v1", KEY_HOME="homeRows_v1";
const SCALE_KEY = "ui_scale";
let pendingReceiptImage = null, pendingReceiptName = ""; // Work
let pendingFamilyImage = null,  pendingFamilyName  = ""; // Family
let currentUser = null;

/* ===== Formatters (no decimals if not needed) ===== */
function isInt(n){ return Number(n) === Math.trunc(Number(n)); }
function fmtAutoPlain(n){
  const num = Number(n||0);
  return isInt(num) ? String(num) : num.toFixed(2);
}
function fmtAutoCurrency(n){
  const num = Number(n||0);
  const opts = {
    style:'currency',
    currency:'USD',
    minimumFractionDigits: isInt(num) ? 0 : 2,
    maximumFractionDigits: isInt(num) ? 0 : 2
  };
  return new Intl.NumberFormat('en-US', opts).format(num);
}

/* ====== AUTH HELPERS ====== */
const authView = byId("authView");
const appView  = byId("appView");
const authMsg  = byId("authMsg");
const signOutBtn = byId("signOutBtn");
const REMEMBER_KEY = "authRemember";
const REMEMBER_EMAIL = "authRememberEmail";

function showAuthMessage(msg, isError=true){
  if (!authMsg) return;
  authMsg.style.color = isError ? "var(--bad)" : "var(--good)";
  authMsg.textContent = msg || "";
}
function toggleUI(){
  if (currentUser){
    if (authView) authView.style.display = "none";
    if (appView)  appView.style.display  = "block";
    if (signOutBtn) signOutBtn.style.display = "inline-block";
  } else {
    if (appView)  appView.style.display  = "none";
    if (authView) authView.style.display = "flex";
    if (signOutBtn) signOutBtn.style.display = "none";
  }
}
async function doSignIn(email, password){
  showAuthMessage("");
  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if (error){ showAuthMessage(error.message || "Sign-in failed"); return; }
  currentUser = data.user || null;

  // remember me
  const remember = byId("rememberMe")?.checked;
  try {
    localStorage.setItem(REMEMBER_KEY, remember ? "1" : "0");
    localStorage.setItem(REMEMBER_EMAIL, remember ? email : "");
  } catch {}

  toggleUI();
  await loadFromDBAndRender();
}
async function doSignUp(email, password){
  showAuthMessage("");
  const { data, error } = await supabase.auth.signUp({ email, password });
  if (error){ showAuthMessage(error.message || "Sign-up failed"); return; }
  showAuthMessage("Account created. If email confirmation is required, check your inbox.", false);
  try { await doSignIn(email, password); } catch {}
}
async function doSignOut(){
  await supabase.auth.signOut();
  currentUser = null;
  toggleUI();
}

/* Hook up auth form */
byId("authLoginForm")?.addEventListener("submit", (e)=>{
  e.preventDefault();
  const email = byId("authEmail").value.trim();
  const password = byId("authPassword").value;
  if (!email || !password){ showAuthMessage("Email and password are required."); return; }
  doSignIn(email, password);
});
byId("authCreateBtn")?.addEventListener("click", ()=>{
  const email = byId("authEmail").value.trim();
  const password = byId("authPassword").value;
  if (!email || !password){ showAuthMessage("Enter email and password to create an account."); return; }
  doSignUp(email, password);
});
signOutBtn?.addEventListener("click", doSignOut);

// restore remember me
(function restoreRemember(){
  const remembered = localStorage.getItem(REMEMBER_KEY) === "1";
  const email = localStorage.getItem(REMEMBER_EMAIL) || "";
  if (byId("rememberMe")) byId("rememberMe").checked = remembered;
  if (remembered && email && byId("authEmail")) byId("authEmail").value = email;
})();

/* ===== Language ===== */
const langStrings = {
  en: {
    appTitle: "Money Tracker",
    wages: "Wages", grocery: "Work Transactions", reimb: "Reimbursement", family: "Family Transactions",
    enterWage: "Enter Your Wage", enterReceipt: "Enter New Receipt", enterReimb: "Enter Your Reimbursement", enterFamily: "Enter Family Transaction",
    date: "Date", hours: "Hours", wageAmount: "Wage Amount", method: "Method", notes: "Notes", actions: "Actions",
    total: "Total", store: "Store", last4: "Last 4", amount: "Amount", attachment: "Attachment",
    kpiReceipts: "Total Family", kpiExp: "Total Expense", kpiReimb: "Total Reimbursed", kpiWages: "Total Wages",
    emptyWages: "No wage records yet", emptyGrocery: "No work transactions yet", emptyReimb: "No reimbursements yet", emptyFamily: "No family transactions yet",
    confirmDelete: "Delete this row?", upload: "📎 Upload",
    filter: "Filter",
    confirmDeleteTitle: "Confirm Delete",
    confirmDeleteMsg: "Are you sure you want to delete this row?",
    cancel: "Cancel",
    delete: "Delete",
    receiptAttachment: "Receipt Attachment",
    submit: "Submit",
    signOut: "Sign out",
    clear: "Clear",
    add: "Add",
    multiDeviceWarning: "⚠️ Notice: Using the same login on multiple devices simultaneously may cause data synchronization issues. Please sign out from other devices before logging in here.",
    cash: "Cash", check: "Check", zelle: "Zelle", other: "Other",
    creditCard: "Credit Card", debitCard: "Debit Card"
  },
  vi: {
    appTitle: "Theo dõi tiền",
    wages: "Lương", grocery: "Giao dịch công việc", reimb: "Hoàn tiền", family: "Chi tiêu gia đình",
    enterWage: "Nhập lương", enterReceipt: "Nhập hóa đơn mới", enterReimb: "Nhập hoàn tiền", enterFamily: "Nhập giao dịch gia đình",
    date: "Ngày", hours: "Giờ", wageAmount: "Tiền lương", method: "Phương thức", notes: "Ghi chú", actions: "Thao tác",
    total: "Tổng cộng", store: "Cửa hàng", last4: "4 số cuối", amount: "Số tiền", attachment: "Đính kèm",
    kpiReceipts: "Tổng gia đình", kpiExp: "Tổng chi tiêu", kpiReimb: "Tổng hoàn trả", kpiWages: "Tổng lương",
    emptyWages: "Chưa có dữ liệu lương", emptyGrocery: "Chưa có giao dịch công việc", emptyReimb: "Chưa có hoàn tiền", emptyFamily: "Chưa có giao dịch gia đình",
    confirmDelete: "Xóa dòng này?", upload: "📎 Tải lên",
    filter: "Bộ lọc",
    confirmDeleteTitle: "Xác nhận xoá",
    confirmDeleteMsg: "Bạn có chắc muốn xoá dòng này?",
    cancel: "Hủy",
    delete: "Xoá",
    receiptAttachment: "Đính kèm hoá đơn",
    submit: "Gửi",
    signOut: "Đăng xuất",
    clear: "Xóa",
    add: "Thêm",
    multiDeviceWarning: "⚠️ Lưu ý: Sử dụng cùng một tài khoản trên nhiều thiết bị cùng lúc có thể gây ra lỗi đồng bộ dữ liệu. Vui lòng đăng xuất khỏi các thiết bị khác trước khi đăng nhập tại đây.",
    cash: "Tiền mặt", check: "Séc", zelle: "Zelle", other: "Khác",
    creditCard: "Thẻ tín dụng", debitCard: "Thẻ ghi nợ"
  }
};

function fmtUSD(n){ return fmtAutoCurrency(n); }
let currentLang = "en";

function setLang(code){
  currentLang = code;
  const t = langStrings[code] || langStrings.en;

  byId("appTitle")?.replaceChildren(t.appTitle);

  byId("wagesTitle")?.replaceChildren(t.wages);
  byId("groceryTitle")?.replaceChildren(t.grocery);
  byId("reimbTitle")?.replaceChildren(t.reimb);
  byId("familyTitle")?.replaceChildren(t.family);

  byId("wagesModalTitle")?.replaceChildren(t.enterWage);
  byId("groceryModalTitle")?.replaceChildren(t.enterReceipt);
  byId("reimbModalTitle")?.replaceChildren(t.enterReimb);
  byId("familyModalTitle")?.replaceChildren(t.enterFamily);

  byId("wagesHead") && (byId("wagesHead").innerHTML =
    `<th>${t.actions}</th><th>${t.date}</th><th>${t.hours}</th><th>${t.wageAmount}</th><th>${t.method}</th><th>${t.notes}</th>`);

  byId("groceryHead") && (byId("groceryHead").innerHTML =
    `<th>${t.actions}</th><th>${t.date}</th><th>${t.store}</th><th>${t.total}</th><th>${t.method}</th><th>${t.last4}</th><th>${t.notes}</th><th>${t.attachment}</th>`);

  byId("reimbHead") && (byId("reimbHead").innerHTML =
    `<th>${t.actions}</th><th>${t.date}</th><th>${t.amount}</th><th>${t.method}</th><th>${t.notes}</th>`);

  byId("homeHead") && (byId("homeHead").innerHTML =
    `<th>${t.actions}</th><th>${t.date}</th><th>${t.store}</th><th>${t.total}</th><th>${t.method}</th><th>${t.last4}</th><th>${t.notes}</th><th>${t.attachment}</th>`);

  byId("attachReceiptBtn")?.replaceChildren(t.upload);
  byId("attachFamilyBtn")?.replaceChildren(t.upload);

  byId("kpiReceiptsLabel")?.replaceChildren(t.kpiReceipts);
  byId("kpiExpLabel")?.replaceChildren(t.kpiExp);
  byId("kpiReimbLabel")?.replaceChildren(t.kpiReimb);
  byId("kpiWagesLabel")?.replaceChildren(t.kpiWages);
  // Fallbacks prevent 'undefined' if a key is missing
  byId("filterLabel")?.replaceChildren(t.filter || "Filter");
  byId("confirmDeleteTitle")?.replaceChildren(t.confirmDeleteTitle || "Confirm Delete");
  byId("confirmDeleteMsg")?.replaceChildren(t.confirmDeleteMsg || "Are you sure you want to delete this row?");
  byId("cancelDeleteBtn")?.replaceChildren(t.cancel || "Cancel");
  byId("confirmDeleteBtn")?.replaceChildren(t.delete || "Delete");
  byId("receiptAttachTitle")?.replaceChildren(t.receiptAttachment || "Receipt Attachment");

  // Submit buttons
  byId("addWagesRow")?.replaceChildren(t.submit);
  byId("addReceipt")?.replaceChildren(t.submit);
  byId("addReimbOnlyRowSubmit")?.replaceChildren(t.submit);
  byId("addFamilySubmit")?.replaceChildren(t.submit);

  // Add buttons
  byId("btnEnterReceipt")?.replaceChildren(t.add);
  byId("addReimbOnlyRow")?.replaceChildren(t.add);
  byId("addWageRow")?.replaceChildren(t.add);
  byId("addFamilyRow")?.replaceChildren(t.add);

  // Update select options
  updateSelectOptions();

  // Update field labels
  updateFieldLabels();

  byId("filterLabel")?.replaceChildren(t.filter);
  byId("confirmDeleteTitle")?.replaceChildren(t.confirmDeleteTitle);
  byId("confirmDeleteMsg")?.replaceChildren(t.confirmDeleteMsg);
  byId("cancelDeleteBtn")?.replaceChildren(t.cancel);
  byId("confirmDeleteBtn")?.replaceChildren(t.delete);
  byId("receiptAttachTitle")?.replaceChildren(t.receiptAttachment);

  // Sign out and clear buttons
  byId("signOutBtn")?.replaceChildren(t.signOut);
  byId("clearDateFilter")?.replaceChildren(t.clear);

  // Multi-device warning
  byId("multiDeviceWarning")?.replaceChildren(t.multiDeviceWarning);

  renderAll();
}

function updateSelectOptions(){
  // Keep payment options in English only (not translated)
  
  // Update wage method options
  const wMethod = byId("wMethod");
  if (wMethod) {
    wMethod.innerHTML = `<option>Cash</option><option>Check</option><option>Zelle</option><option>Other</option>`;
  }
  
  // Update grocery payment method options (removed Debit Card)
  const gPayMethod = byId("gPayMethod");
  if (gPayMethod) {
    gPayMethod.innerHTML = `<option>Credit Card</option><option>Cash</option><option>Check</option><option>Other</option>`;
  }
  
  // Update reimbursement method options
  const rMethod = byId("rMethod");
  if (rMethod) {
    rMethod.innerHTML = `<option>Cash</option><option>Check</option><option>Zelle</option><option>Other</option>`;
  }
  
  // Update family payment method options (removed Debit Card)
  const fPayMethod = byId("fPayMethod");
  if (fPayMethod) {
    fPayMethod.innerHTML = `<option>Credit Card</option><option>Cash</option><option>Check</option><option>Other</option>`;
  }
}

function updateFieldLabels(){
  const t = langStrings[currentLang];
  
  // Wages modal labels
  if (byId("lblWDate")) byId("lblWDate").childNodes[0].textContent = t.date;
  if (byId("lblWHours")) byId("lblWHours").childNodes[0].textContent = t.hours;
  if (byId("lblWAmount")) byId("lblWAmount").childNodes[0].textContent = t.wageAmount;
  if (byId("lblWMethod")) byId("lblWMethod").childNodes[0].textContent = t.method;
  if (byId("lblWNotes")) byId("lblWNotes").childNodes[0].textContent = t.notes;
  
  // Receipt modal labels
  if (byId("lblGDate")) byId("lblGDate").childNodes[0].textContent = t.date;
  if (byId("lblGVendor")) byId("lblGVendor").childNodes[0].textContent = t.store;
  if (byId("lblGTotal")) byId("lblGTotal").childNodes[0].textContent = t.total;
  if (byId("lblGMethod")) byId("lblGMethod").childNodes[0].textContent = t.method;
  if (byId("lblGCard")) byId("lblGCard").childNodes[0].textContent = t.last4;
  if (byId("lblGNotes")) byId("lblGNotes").childNodes[0].textContent = t.notes;
  
  // Reimbursement modal labels
  if (byId("lblRDate")) byId("lblRDate").childNodes[0].textContent = t.date;
  if (byId("lblRAmount")) byId("lblRAmount").childNodes[0].textContent = t.amount;
  if (byId("lblRMethod")) byId("lblRMethod").childNodes[0].textContent = t.method;
  if (byId("lblRNotes")) byId("lblRNotes").childNodes[0].textContent = t.notes;
  
  // Family modal labels
  if (byId("lblFDate")) byId("lblFDate").childNodes[0].textContent = t.date;
  if (byId("lblFVendor")) byId("lblFVendor").childNodes[0].textContent = t.store;
  if (byId("lblFTotal")) byId("lblFTotal").childNodes[0].textContent = t.total;
  if (byId("lblFMethod")) byId("lblFMethod").childNodes[0].textContent = t.method;
  if (byId("lblFCard")) byId("lblFCard").childNodes[0].textContent = t.last4;
  if (byId("lblFNotes")) byId("lblFNotes").childNodes[0].textContent = t.notes;
}

document.addEventListener("DOMContentLoaded", ()=>{
  document.getElementById("langSwitch").addEventListener("change", e => setLang(e.target.value));
  // Initialize field labels with current language
  updateFieldLabels();
});

/* ===== UI Helpers ===== */
function toast(msg){ /* quiet */ }

function showLoading(text = "Processing...") {
  const overlay = byId("loadingOverlay");
  const textEl = byId("loadingText");
  if (textEl) textEl.textContent = text;
  if (overlay) overlay.style.display = "flex";
}

function hideLoading() {
  const overlay = byId("loadingOverlay");
  if (overlay) overlay.style.display = "none";
}

function setButtonLoading(buttonId, isLoading) {
  const btn = byId(buttonId);
  if (!btn) return;
  
  if (isLoading) {
    btn.classList.add("processing");
    btn.disabled = true;
    btn.dataset.originalText = btn.textContent;
    btn.textContent = "";
  } else {
    btn.classList.remove("processing");
    btn.disabled = false;
    if (btn.dataset.originalText) {
      btn.textContent = btn.dataset.originalText;
      delete btn.dataset.originalText;
    }
  }
}

// Connection status management
function updateConnectionStatus(status) {
  const statusEl = byId("connectionStatus");
  const iconEl = byId("connectionIcon");
  const textEl = byId("connectionText");
  
  if (!statusEl || !iconEl || !textEl) return;
  
  // Remove all status classes
  statusEl.classList.remove("online", "connecting");
  
  switch (status) {
    case "online":
      statusEl.style.display = "none"; // Hide when online
      break;
    case "connecting":
      statusEl.style.display = "flex";
      statusEl.classList.add("connecting");
      iconEl.textContent = "⚡";
      textEl.textContent = "Connecting...";
      break;
    case "offline":
    default:
      statusEl.style.display = "flex";
      iconEl.textContent = "🌐";
      textEl.textContent = "Offline";
      break;
  }
}

/* ===== Enhanced Submission Protection ===== */
let isSubmitting = false;

function startSubmission(modalId, buttonId) {
  if (isSubmitting) return false; // Prevent double submission
  
  isSubmitting = true;
  setButtonLoading(buttonId, true);
  
  // Block modal interactions
  const modal = byId(modalId);
  if (modal) modal.classList.add("processing");
  
  return true;
}

function endSubmission(modalId, buttonId, success = true) {
  isSubmitting = false;
  setButtonLoading(buttonId, false);
  
  // Unblock modal interactions
  const modal = byId(modalId);
  if (modal) modal.classList.remove("processing");
  
  if (!success) {
    showErrorNotification("Submission failed. Please try again.", () => {
      // Retry by clicking the button again
      const btn = byId(buttonId);
      if (btn) btn.click();
    });
  }
}

function showErrorNotification(message, retryCallback = null) {
  // Remove any existing notifications
  const existing = document.querySelector(".error-notification");
  if (existing) existing.remove();
  
  // Create new notification
  const notification = document.createElement("div");
  notification.className = "error-notification";
  notification.innerHTML = `
    <div>${message}</div>
    ${retryCallback ? '<button class="retry-btn">Try Again</button>' : ''}
  `;
  
  if (retryCallback) {
    const retryBtn = notification.querySelector('.retry-btn');
    retryBtn.onclick = () => {
      notification.remove();
      retryCallback();
    };
  }
  
  document.body.appendChild(notification);
  
  // Trigger animation
  setTimeout(() => notification.classList.add('show'), 50);
  
  // Auto-remove after 8 seconds (longer for retry option)
  setTimeout(() => {
    if (notification.parentNode) {
      notification.classList.remove('show');
      setTimeout(() => notification.remove(), 300);
    }
  }, 8000);
}

function highlightNewRow(tableBodyId, rowIndex) {
  const tbody = byId(tableBodyId);
  if (!tbody) return;
  
  const row = tbody.querySelector(`tr[data-i="${rowIndex}"]`);
  if (!row) return;
  
  // Add highlight animation
  row.classList.add('row-highlight');
  
  // Scroll the highlighted row into view (since newest rows are now at top)
  row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  
  // Remove the class after animation completes
  setTimeout(() => {
    row.classList.remove('row-highlight');
  }, 2000);
}

async function safeSubmit(modalId, buttonId, submitFunction) {
  if (!startSubmission(modalId, buttonId)) return;
  
  try {
    await submitFunction();
    endSubmission(modalId, buttonId, true);
  } catch (error) {
    console.error("Submission error:", error);
    
    // Provide more specific error messages
    let errorMessage = "Submission failed";
    if (error.message) {
      if (error.message.includes("network") || error.message.includes("fetch")) {
        errorMessage = "Network error. Check connection";
      } else if (error.message.includes("timeout")) {
        errorMessage = "Request timed out";
      } else if (error.message.includes("unauthorized") || error.message.includes("auth")) {
        errorMessage = "Authentication error. Please sign in again";
      } else {
        errorMessage = `Error: ${error.message.substring(0, 50)}`;
      }
    }
    
    endSubmission(modalId, buttonId, false);
    showErrorNotification(errorMessage, () => {
      // Retry by clicking the button again
      const btn = byId(buttonId);
      if (btn) btn.click();
    });
  }
}

function today(){ 
  // Get current date in Pacific timezone (PST/PDT) properly for HTML date inputs
  const now = new Date();
  
  // Use Intl.DateTimeFormat to get the date parts in Pacific timezone
  const formatter = new Intl.DateTimeFormat('en-CA', {
    timeZone: 'America/Los_Angeles',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  });
  
  return formatter.format(now); // Returns YYYY-MM-DD format for HTML date inputs
}

function todayDisplay(){ 
  // Get current date in Pacific timezone formatted for mobile display
  const now = new Date();
  
  // Use Intl.DateTimeFormat to get the date parts in Pacific timezone
  const formatter = new Intl.DateTimeFormat('en-US', {
    timeZone: 'America/Los_Angeles',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  });
  
  const parts = formatter.formatToParts(now);
  const month = parts.find(part => part.type === 'month').value;
  const day = parts.find(part => part.type === 'day').value;
  const year = parts.find(part => part.type === 'year').value;
  
  return `${month}/${day}/${year}`; // Returns MM/DD/YYYY format for mobile compatibility
}

function isValidMoney(s){
  return /^(0|[1-9]\d*)(\.\d{1,2})?$/.test(String(s).trim());
}
function normMoney(s){
  if (s === "" || s === null || s === undefined) return "0.00";
  const str = String(s).trim();
  if (!isValidMoney(str)) return null;
  return Number(str).toFixed(2);
}
function validate(el){
  if(!el.value && el.value !== 0){ el.classList.add("mandatory-missing"); setTimeout(()=>el.classList.remove("mandatory-missing"), 900); return false; }
  return true;
}

/* ===== Icons ===== */
function pencilSVG(){return `<svg viewBox="0 0 24 24" fill="none"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z" fill="currentColor"/><path d="M20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" fill="currentColor"/></svg>`}
function trashSVG(){return `<svg viewBox="0 0 24 24" fill="none"><path d="M6 7h12M9 7V5a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2m-9 0l1 12a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`}
function clipSVG(){return `<svg viewBox="0 0 24 24" fill="none"><path d="M21.44 11.05l-9.19 9.19a5.5 5.5 0 01-7.78-7.78l9.19-9.19a3.5 3.5 0 015 5l-9.19 9.19a1.5 1.5 0 01-2.12-2.12l8.48-8.48" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;}
function photoSVG(){return `<svg viewBox="0 0 24 24" fill="none"><path d="M4 7h2l2-3h8l2 3h2a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V9a2 2 0 012-2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="13" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;}

/* ===== Render helpers ===== */
function td(text){ return `<td title="${(text??'').toString().replace(/"/g,'&quot;')}">${text??""}</td>`; }

/* ===== Row builders (display no decimals when not needed) ===== */
function wagesRowEl(r,i){
  const tr=document.createElement("tr");
  tr.setAttribute('data-i', i); // Set data-i on the tr element for highlighting
  tr.innerHTML=`
    <td class="actions-cell">
      <button class="icon-btn edit-wages" title="Edit" data-i="${i}" aria-label="Edit">${pencilSVG()}</button>
      <button class="icon-btn" title="Delete" data-act="del" data-type="wages" data-i="${i}" aria-label="Delete">${trashSVG()}</button>
    </td>
    ${td(r.date)}${td(fmtAutoPlain(r.hours))}${td(fmtAutoPlain(r.amount))}${td(r.method)}${td(r.notes)}`;
  return tr;
}

function reimbRowEl(r,i){
  const tr=document.createElement("tr");
  tr.dataset.i=i;
  tr.dataset.hasAttachment = (!!r.receiptImg).toString();
  if (r.receiptImg) { try { tr.setAttribute("data-receipt-src", r.receiptImg); } catch(_){} }
  tr.innerHTML=`
    <td class="actions-cell">
      <button class="icon-btn edit-reimb" title="Edit" data-i="${i}">${pencilSVG()}</button>
      <button class="icon-btn" title="Delete" data-act="del" data-type="reimb" data-i="${i}">${trashSVG()}</button>
    </td>
    ${td(r.date)}${td(r.vendor)}${td(fmtAutoPlain(r.expense))}${td(r.payMethod)}${td(r.cardLast4)}${td(r.notes)}
    <td class="actions-cell">
      ${r.receiptImg
        ? `<button class="icon-btn view-attachment" title="View Attachment" data-i="${i}">${clipSVG()}</button>`
        : `<button class="icon-btn add-attachment" title="Add Attachment" data-i="${i}">${photoSVG()}</button>`}
    </td>`;
  return tr;
}

function homeRowEl(r,i){
  const tr=document.createElement("tr");
  tr.dataset.i=i;
  tr.dataset.hasAttachment = (!!r.receiptImg).toString();
  if (r.receiptImg) { try { tr.setAttribute("data-receipt-src", r.receiptImg); } catch(_){} }
  tr.innerHTML=`
    <td class="actions-cell">
      <button class="icon-btn edit-home" title="Edit" data-i="${i}">${pencilSVG()}</button>
      <button class="icon-btn" title="Delete" data-act="del" data-type="home" data-i="${i}">${trashSVG()}</button>
    </td>
    ${td(r.date)}${td(r.vendor)}${td(fmtAutoPlain(r.expense))}${td(r.payMethod)}${td(r.cardLast4)}${td(r.notes)}
    <td class="actions-cell">
      ${r.receiptImg
        ? `<button class="icon-btn view-attachment" title="View Attachment" data-i="${i}" data-type="home">${clipSVG()}</button>`
        : `<button class="icon-btn add-attachment" title="Add Attachment" data-i="${i}" data-type="home">${photoSVG()}</button>`}
    </td>`;
  return tr;
}

function reimbOnlyRowEl(r,i){
  const tr=document.createElement("tr");
  tr.setAttribute('data-i', i); // Set data-i on the tr element for highlighting
  tr.innerHTML=`
    <td class="actions-cell">
      <button class="icon-btn edit-reimbonly" title="Edit" data-i="${i}">${pencilSVG()}</button>
      <button class="icon-btn" title="Delete" data-act="del" data-type="reimbonly" data-i="${i}">${trashSVG()}</button>
    </td>
    ${td(r.date)}${td(fmtAutoPlain(r.amount))}${td(r.method)}${td(r.notes)}`;
  return tr;
}

/* ===== Renderers ===== */
function renderWages(){
  const tb = byId("wagesBody"); if (!tb) return; tb.innerHTML = "";
  let added = 0;
  
  // Create array of filtered rows with their original indices
  const filteredRows = [];
  wagesRows.forEach((r,i)=>{
    if (applyDateFilter([r], "date").length) {
      filteredRows.push({row: r, index: i});
    }
  });
  
  // Reverse to show newest first
  filteredRows.reverse().forEach(({row, index})=>{
    tb.appendChild(wagesRowEl(row, index));
    added++;
  });
  
  // Ensure at least 3 rows are shown
  const minRows = 3;
  if (added === 0){
    // Show empty message row plus 2 placeholder rows
    const tr = document.createElement("tr"); tr.className = "placeholder-row";
    tr.innerHTML = `<td colspan="6">${langStrings[currentLang].emptyWages}</td>`;
    tb.appendChild(tr);
    added++;
  }
  
  // Add empty placeholder rows to reach minimum
  while (added < minRows) {
    const tr = document.createElement("tr"); tr.className = "placeholder-row empty-row";
    tr.innerHTML = `<td colspan="6">―</td>`;
    tb.appendChild(tr);
    added++;
  }
  
  updateSectionTotals();
}

function renderReimb(){
  const tb = byId("reimbBody"); if (!tb) return; tb.innerHTML = "";
  let added = 0;
  
  // Create array of filtered rows with their original indices
  const filteredRows = [];
  reimbRows.forEach((r,i)=>{
    if (applyDateFilter([r], "date").length) {
      filteredRows.push({row: r, index: i});
    }
  });
  
  // Reverse to show newest first
  filteredRows.reverse().forEach(({row, index})=>{
    tb.appendChild(reimbRowEl(row, index));
    added++;
  });
  
  // Ensure at least 3 rows are shown
  const minRows = 3;
  if (added === 0){
    // Show empty message row plus 2 placeholder rows
    const tr = document.createElement("tr"); tr.className = "placeholder-row";
    tr.innerHTML = `<td colspan="8">${langStrings[currentLang].emptyGrocery}</td>`;
    tb.appendChild(tr);
    added++;
  }
  
  // Add empty placeholder rows to reach minimum
  while (added < minRows) {
    const tr = document.createElement("tr"); tr.className = "placeholder-row empty-row";
    tr.innerHTML = `<td colspan="8">―</td>`;
    tb.appendChild(tr);
    added++;
  }
  
  updateSectionTotals();
}

function renderHome(){
  const tb = byId("homeBody"); if (!tb) return; tb.innerHTML = "";
  let added = 0;
  
  // Create array of filtered rows with their original indices
  const filteredRows = [];
  homeRows.forEach((r,i)=>{
    if (applyDateFilter([r], "date").length) {
      filteredRows.push({row: r, index: i});
    }
  });
  
  // Reverse to show newest first
  filteredRows.reverse().forEach(({row, index})=>{
    tb.appendChild(homeRowEl(row, index));
    added++;
  });
  
  // Ensure at least 3 rows are shown
  const minRows = 3;
  if (added === 0){
    // Show empty message row plus 2 placeholder rows
    const tr = document.createElement("tr"); tr.className = "placeholder-row";
    tr.innerHTML = `<td colspan="8">${langStrings[currentLang].emptyFamily}</td>`;
    tb.appendChild(tr);
    added++;
  }
  
  // Add empty placeholder rows to reach minimum
  while (added < minRows) {
    const tr = document.createElement("tr"); tr.className = "placeholder-row empty-row";
    tr.innerHTML = `<td colspan="8">―</td>`;
    tb.appendChild(tr);
    added++;
  }
  
  updateSectionTotals();
}

function renderReimbOnly(){
  const tb = byId("reimbOnlyBody"); if (!tb) return; tb.innerHTML = "";
  let added = 0;
  
  // Create array of filtered rows with their original indices
  const filteredRows = [];
  reimbOnlyRows.forEach((r,i)=>{
    if (applyDateFilter([r], "date").length) {
      filteredRows.push({row: r, index: i});
    }
  });
  
  // Reverse to show newest first
  filteredRows.reverse().forEach(({row, index})=>{
    tb.appendChild(reimbOnlyRowEl(row, index));
    added++;
  });
  
  if (added === 0){
    const tr = document.createElement("tr"); tr.className = "placeholder-row";
    tr.innerHTML = `<td colspan="5">${langStrings[currentLang].emptyReimb}</td>`;
    tb.appendChild(tr);
    added++;
  }
  
  // Add empty placeholder rows to reach minimum
  const minRows = 3;
  while (added < minRows) {
    const tr = document.createElement("tr"); tr.className = "placeholder-row empty-row";
    tr.innerHTML = `<td colspan="5">―</td>`;
    tb.appendChild(tr);
    added++;
  }
  
  updateSectionTotals();
}

function renderAll(){ renderWages(); renderReimb(); renderReimbOnly(); renderHome(); updateKpis(); }

/* ===== KPIs (always unfiltered; dynamic decimals) ===== */
function updateKpis(){
  const sum = (arr, key) =>
    arr.reduce((a,b)=> a + (parseFloat((b[key]??"").toString().replace(/[^0-9.-]/g,""))||0), 0);

  // KPI #1 shows Total Family
  $("#kCount").textContent = fmtAutoCurrency(sum(homeRows,"expense"));
  $("#kExp").textContent   = fmtAutoCurrency(sum(reimbRows,"expense") + sum(homeRows,"expense"));
  $("#kReimb").textContent = fmtAutoCurrency(sum(reimbOnlyRows,"amount"));
  $("#kWages").textContent = fmtAutoCurrency(sum(wagesRows,"amount"));
}

/* ===== Persistence (local) ===== */
function cloneWithoutBigImages(arr){
  return (arr||[]).map(r=>{
    const c = {...r};
    if (typeof c.receiptImg === "string" && c.receiptImg.startsWith("data:")) {
      delete c.receiptImg;
    }
    return c;
  });
}
function safeSetLocal(key, val){
  try{ localStorage.setItem(key, JSON.stringify(val)); }
  catch(e){
    try{
      const smaller = (val||[]).map(r=>{ const c={...r}; delete c.notes; return c; });
      localStorage.setItem(key, JSON.stringify(smaller));
    }catch{}
  }
}
function saveAll(){
  safeSetLocal(KEY_WAGES, wagesRows);
  safeSetLocal(KEY_REIMB, cloneWithoutBigImages(reimbRows));
  safeSetLocal(KEY_REIMBONLY, reimbOnlyRows);
  safeSetLocal(KEY_HOME, cloneWithoutBigImages(homeRows));
  updateKpis();
}
function loadAll(){
  try{wagesRows=JSON.parse(localStorage.getItem(KEY_WAGES)||"[]")}catch{wagesRows=[]}
  try{reimbRows=JSON.parse(localStorage.getItem(KEY_REIMB)||"[]")}catch{reimbRows=[]}
  try{reimbOnlyRows=JSON.parse(localStorage.getItem(KEY_REIMBONLY)||"[]")}catch{reimbOnlyRows=[]}
  try{homeRows=JSON.parse(localStorage.getItem(KEY_HOME)||"[]")}catch{homeRows=[]}
  renderAll();
}

/* ===== Auth state ===== */
async function getSessionUser() {
  const { data: { session} } = await supabase.auth.getSession();
  currentUser = session?.user ?? null;
  return currentUser;
}
supabase.auth.onAuthStateChange((_evt, session) => {
  currentUser = session?.user ?? null;
  toggleUI();
  if (currentUser) loadFromDBAndRender();
});

/* ===== Storage upload for receipts (quiet fallback) ===== */
let storageOK = false;
async function preflightStorage() {
  // Force storage to be unavailable for now - use base64 fallback
  console.log("🔧 Storage disabled - using base64 fallback mode");
  storageOK = false;
  storageChecked = true;
  return storageOK;
}
/* ===== Optimized image compression and loading ===== */
function compressImage(file, maxWidth = 800, quality = 0.7) {
  return new Promise((resolve) => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
    
    img.onload = () => {
      // Calculate new dimensions maintaining aspect ratio
      let { width, height } = img;
      if (width > maxWidth) {
        height = (height * maxWidth) / width;
        width = maxWidth;
      }
      
      canvas.width = width;
      canvas.height = height;
      
      // Draw and compress
      ctx.drawImage(img, 0, 0, width, height);
      const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
      
      console.log(`📏 Image compressed: ${Math.round(file.size/1024)}KB → ${Math.round(compressedDataUrl.length*0.75/1024)}KB`);
      resolve(compressedDataUrl);
    };
    
    img.src = URL.createObjectURL(file);
  });
}

async function uploadReceiptToStorage(fileOrDataUrl, folder = "work") {
  console.log("📤 Starting optimized upload process...", { fileOrDataUrl: typeof fileOrDataUrl, folder });
  
  await preflightStorage();
  if (!storageOK) {
    console.log("💾 Using optimized base64 storage...");
    if (typeof fileOrDataUrl === "string") return fileOrDataUrl;
    
    // Compress image before storing as base64
    if (fileOrDataUrl.size > 500000) { // If larger than 500KB
      console.log("🗜️ Compressing large image...");
      return await compressImage(fileOrDataUrl);
    }
    
    return await fileToDataURL(fileOrDataUrl);
  }

  // Storage code (won't execute due to forced fallback)
  if (!currentUser) {
    console.warn("No authenticated user for storage upload, falling back to data URL");
    return typeof fileOrDataUrl === "string" ? fileOrDataUrl : await fileToDataURL(fileOrDataUrl);
  }

  let blob, ext = "png";
  if (typeof fileOrDataUrl === "string" && fileOrDataUrl.startsWith("data:")) {
    const res = await fetch(fileOrDataUrl);
    blob = await res.blob();
    ext = (blob.type || "image/png").split("/")[1] || "png";
  } else {
    blob = fileOrDataUrl;
    ext = (blob?.type || "image/png").split("/")[1] || "png";
  }

  const userFolder = currentUser.id;
  const path = `${userFolder}/${folder}/${Date.now()}-${Math.random().toString(36).slice(2)}.${ext}`;
  
  try {
    const { data, error } = await supabase.storage.from("receipts").upload(path, blob, { upsert: false });
    if (error) {
      console.error("Storage upload error:", error);
      return typeof fileOrDataUrl === "string" ? fileOrDataUrl : await fileToDataURL(fileOrDataUrl);
    }

    const { data: pub } = supabase.storage.from("receipts").getPublicUrl(path);
    return pub.publicUrl;
  } catch (e) {
    console.error("Storage upload failed:", e);
    return typeof fileOrDataUrl === "string" ? fileOrDataUrl : await fileToDataURL(fileOrDataUrl);
  }
}

/* ===== DB mapping + CRUD ===== */
const T_WAGES  = "wages";
const T_WORK   = "work_expense";
const T_REIMB  = "reimbursements";
const T_FAMILY = "family_expense";

function nowIso(){ return new Date().toISOString(); }
function ensureUser(){ if (!currentUser) throw new Error("No signed-in user. DB writes blocked."); }

/* Fetch everything (KPIs unfiltered) */
async function fetchRows(table, dateField="date"){
  ensureUser();
  
  // Optimized query with user isolation and better ordering
  let q = supabase
    .from(table)
    .select("*")
    .eq("user_id", currentUser.id) // ← CRITICAL: Only fetch current user's data
    .order(dateField, { ascending: false }) // Recent first is often faster
    .order("id", { ascending: false }); // Secondary sort for consistency
    
  const { data, error } = await q;
  if (error) throw error;
  return data || [];
}

/* INSERT vs UPDATE split to avoid 428C9 on identity columns */
async function upsertRow(table, payload){
  ensureUser();

  const hasId = !!payload?.id;
  const base  = { ...payload, modified_on: nowIso() };

  if (hasId) {
    // Do NOT send `id` in UPDATE payload (identity column); target row via .eq("id", ...)
    const updateBody = { ...base };
    delete updateBody.id;

    const { data, error } = await supabase
      .from(table)
      .update(updateBody)
      .eq("id", payload.id)
      .select()
      .maybeSingle();

    if (error || !data) {
      // If no row updated (e.g., local/import carried a non-existent id), INSERT without id
      const toInsert = { ...base };
      delete toInsert.id;
      toInsert.created_on = nowIso();
      const ins = await supabase.from(table).insert(toInsert).select().single();
      if (ins.error) throw ins.error;
      return ins.data;
    }
    return data;
  } else {
    // INSERT path — never send id to IDENTITY ALWAYS column
    const body = { ...base };
    delete body.id;
    body.created_on = nowIso();
    const { data, error } = await supabase.from(table).insert(body).select().single();
    if (error) throw error;
    return data;
  }
}

async function deleteRow(table, id){
  ensureUser();
  // CRITICAL: Only allow deleting rows that belong to current user
  const { error } = await supabase
    .from(table)
    .delete()
    .eq("id", id)
    .eq("user_id", currentUser.id); // ← Prevent deleting other users' data
  if (error) throw error;
}

function mapWorkUIToDB(r){
  const out = { date:r.date, vendor:r.vendor||null,
    expense:r.expense!=null?Number(r.expense):0,
    pay_method:r.payMethod||"Credit Card", card_last4:r.cardLast4||null,
    notes:r.notes||null, receipt_img:r.receiptImg||null };
  if (r.id) out.id = r.id;
  if (currentUser) out.user_id = currentUser.id;
  return out;
}
function mapFamilyUIToDB(r){
  const out = { date:r.date||null, vendor:r.vendor||null,
    expense:r.expense!=null?Number(r.expense):0,
    pay_method:r.payMethod||"Credit Card", card_last4:r.cardLast4||null,
    notes:r.notes||null, receipt_img:r.receiptImg||null };
  if (r.id) out.id = r.id;
  if (currentUser) out.user_id = currentUser.id;
  return out;
}
function mapWageUIToDB(r){
  const out = { date:r.date, hours:r.hours?Number(r.hours):0,
    amount:r.amount?Number(r.amount):0, method:r.method||"Cash", notes:r.notes||null };
  if (r.id) out.id = r.id;
  if (currentUser) out.user_id = currentUser.id;
  return out;
}
function mapReimbOnlyUIToDB(r){
  const out = { date:r.date, amount:r.amount?Number(r.amount):0,
    method:r.method||"Cash", notes:r.notes||null };
  if (r.id) out.id = r.id;
  if (currentUser) out.user_id = currentUser.id;
  return out;
}

function mapWorkDBToUI(r){
  return { id:r.id, date:r.date, vendor:r.vendor, expense:r.expense ?? 0, payMethod:r.pay_method || "Credit Card",
    cardLast4:r.card_last4, notes:r.notes, receiptImg:r.receipt_img,
    receiptName:r.receipt_img ? r.receipt_img.split("/").pop() : "" };
}
function mapFamilyDBToUI(r){
  return { id:r.id, date:r.date, vendor:r.vendor, expense:r.expense ?? 0, payMethod:r.pay_method || "Credit Card",
    cardLast4:r.card_last4, notes:r.notes, receiptImg:r.receipt_img,
    receiptName:r.receipt_img ? r.receipt_img.split("/").pop() : "" };
}
function mapWageDBToUI(r){ return { id:r.id, date:r.date, hours:r.hours ?? 0, amount:r.amount ?? 0, method:r.method || "Cash", notes:r.notes }; }
function mapReimbOnlyDBToUI(r){ return { id:r.id, date:r.date, amount:r.amount ?? 0, method:r.method || "Cash", notes:r.notes }; }

/* ===== DB-aware loading ===== */
async function loadFromDBAndRender() {
  if (!currentUser) { renderAll(); return; }
  
  const startTime = performance.now();
  showLoading("Loading data...");
  updateConnectionStatus("connecting");
  
  try {
    // Load all tables in PARALLEL for faster performance
    const loadTable = async (tableName, orderBy = "date") => {
      try {
        const tableStart = performance.now();
        const result = await fetchRows(tableName, orderBy);
        const tableTime = performance.now() - tableStart;
        console.log(`Loaded ${tableName}: ${result.length} rows in ${tableTime.toFixed(0)}ms`);
        return result;
      } catch (error) {
        console.warn(`Failed to load ${tableName}:`, error);
        
        // Check for network connectivity issues
        if (error.message?.includes('Failed to fetch') || error.message?.includes('NetworkError')) {
          throw new Error(`NETWORK_ERROR: Cannot connect to database. Please check your internet connection.`);
        }
        
        return []; // Return empty array if this table fails for other reasons
      }
    };

    // Start all requests simultaneously (parallel loading)
    const [wages, work, reimb, family] = await Promise.all([
      loadTable(T_WAGES, "date"),
      loadTable(T_WORK, "date"), 
      loadTable(T_REIMB, "date"),
      loadTable(T_FAMILY, "date")
    ]);

    wagesRows = wages.map(mapWageDBToUI);
    reimbRows = work.map(mapWorkDBToUI);
    reimbOnlyRows = reimb.map(mapReimbOnlyDBToUI);
    homeRows = family.map(mapFamilyDBToUI);
    
    const totalTime = performance.now() - startTime;
    console.log(`Total data load completed in ${totalTime.toFixed(0)}ms`);
    
    // Migrate legacy image paths (runs in background)
    migrateLegacyImagePaths().catch(e => console.warn("Migration warning:", e));
    
    saveAll();
    renderAll();
    hideLoading();
    updateConnectionStatus("online");
  } catch (e) {
    console.error("Error loading data:", e);
    hideLoading();
    updateConnectionStatus("offline");
    // Still render with whatever data we have locally
    renderAll();
    
    // Show user-friendly error message based on error type
    if (e.message?.includes('NETWORK_ERROR')) {
      showErrorNotification("🌐 Cannot connect to database. Please check your internet connection and try again.", "Retry", async () => {
        await loadFromDBAndRender();
      });
    } else if (e.message?.includes('timeout') || e.code === '57014') {
      showErrorNotification("⏱️ Database connection timeout. Using local data.", "Retry", async () => {
        await loadFromDBAndRender();
      });
    } else {
      showErrorNotification("⚠️ Unable to load latest data. Using local data.", "Retry", async () => {
        await loadFromDBAndRender();
      });
    }
  }
}

/* ===== Excel Export/Import ===== */
function exportExcel() {
  const wb = XLSX.utils.book_new();
  const wsWages = XLSX.utils.json_to_sheet(wagesRows);
  XLSX.utils.book_append_sheet(wb, wsWages, "Wages");
  const wsReimb = XLSX.utils.json_to_sheet(reimbRows);
  XLSX.utils.book_append_sheet(wb, wsReimb, "Work");
  const wsReimbOnly = XLSX.utils.json_to_sheet(reimbOnlyRows);
  XLSX.utils.book_append_sheet(wb, wsReimbOnly, "Reimbursement");
  const wsHome = XLSX.utils.json_to_sheet(homeRows);
  XLSX.utils.book_append_sheet(wb, wsHome, "Family");
  XLSX.writeFile(wb, "MoneyTracker.xlsx");
}

const LOG_KEY = "activityLog_v1";
let activityLog = [];
function logAction(action, details="") {
  const entry = { time: new Date().toLocaleString(), action, details };
  activityLog.push(entry);
  try{ localStorage.setItem(LOG_KEY, JSON.stringify(activityLog)); }catch{}
}
function loadLog() {
  try { activityLog = JSON.parse(localStorage.getItem(LOG_KEY) || "[]"); }
  catch { activityLog = []; }
}
loadLog();

function importExcel(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data, { type: "array" });

    wagesRows = []; reimbRows = []; reimbOnlyRows = []; homeRows = [];

    if (wb.Sheets["Wages"]) wagesRows = XLSX.utils.sheet_to_json(wb.Sheets["Wages"]);
    if (wb.Sheets["Work"]) reimbRows = XLSX.utils.sheet_to_json(wb.Sheets["Work"]);
    if (wb.Sheets["Reimbursement"]) reimbOnlyRows = XLSX.utils.sheet_to_json(wb.Sheets["Reimbursement"]);
    if (wb.Sheets["Family"]) homeRows = XLSX.utils.sheet_to_json(wb.Sheets["Family"]);

    saveAll();
    renderAll();
    logAction("Import Excel", file.name);

    (async () => {
      if (!currentUser) return;
      try {
        // Strip id before pushing to DB to avoid 428C9 on IDENTITY ALWAYS columns
        for (const r of wagesRows)      { const clean = { ...r }; delete clean.id; await upsertRow(T_WAGES,  mapWageUIToDB(clean)); }
        for (const r of reimbRows)      { const clean = { ...r }; delete clean.id; await upsertRow(T_WORK,   mapWorkUIToDB(clean)); }
        for (const r of reimbOnlyRows)  { const clean = { ...r }; delete clean.id; await upsertRow(T_REIMB,  mapReimbOnlyUIToDB(clean)); }
        for (const r of homeRows)       { const clean = { ...r }; delete clean.id; await upsertRow(T_FAMILY, mapFamilyUIToDB(clean)); }
        await loadFromDBAndRender();
      } catch (e) { console.error("Import push failed:", e); }
    })();
  };
  reader.readAsArrayBuffer(file);
}

/* ===== Date-range filter (tables only) ===== */
let filterStart = "";
let filterEnd   = "";

function inRange(isoDate) {
  if (!isoDate) return false;
  if (filterStart && isoDate < filterStart) return false;
  if (filterEnd   && isoDate > filterEnd)   return false;
  return true;
}
function applyDateFilter(rows, fieldName = "date") {
  if (!filterStart && !filterEnd) return rows;
  return rows.filter(r => inRange((r?.[fieldName]||"").toString().slice(0,10)));
}
function updateSectionTotals(){
  const gSum = applyDateFilter(reimbRows, "date").reduce((a,b)=> a + (parseFloat(b.expense)||0), 0);
  setText("groceryTotal", fmtAutoCurrency(gSum));

  const rSum = applyDateFilter(reimbOnlyRows, "date").reduce((a,b)=> a + (parseFloat(b.amount)||0), 0);
  setText("reimbOnlyTotal", fmtAutoCurrency(rSum));

  const wSum = applyDateFilter(wagesRows, "date").reduce((a,b)=> a + (parseFloat(b.amount)||0), 0);
  setText("wagesTotal", fmtAutoCurrency(wSum));

  const hSum = applyDateFilter(homeRows, "date").reduce((a,b)=> a + (parseFloat(b.expense)||0), 0);
  setText("homeTotal", fmtAutoCurrency(hSum));
}
function applyFilterAndRender(){
  filterStart = byId("filterStart")?.value || "";
  filterEnd   = byId("filterEnd")?.value   || "";
  renderAll();
}
["change","input"].forEach(evt => {
  byId("filterStart")?.addEventListener(evt, applyFilterAndRender);
  byId("filterEnd")?.addEventListener(evt, applyFilterAndRender);
});
byId("clearDateFilter")?.addEventListener("click", () => {
  filterStart = ""; filterEnd = "";
  if (byId("filterStart")) byId("filterStart").value = "";
  if (byId("filterEnd"))   byId("filterEnd").value   = "";
  renderAll();
});

/* ===== Keyboard shortcuts in data-entry modals ===== */
function bindEnterSubmit(modalId, submitBtnId){
  const modal = byId(modalId);
  const submit = byId(submitBtnId);
  if(!modal || !submit) return;
  modal.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      submit.click();
    }
    if(e.key === "Escape"){
      e.preventDefault();
      modal.classList.remove("open");
    }
  });
}
bindEnterSubmit("wagesModal", "addWagesRow");
bindEnterSubmit("receiptModal", "addReceipt");
bindEnterSubmit("reimbOnlyModal", "addReimbOnlyRowSubmit");
bindEnterSubmit("familyModal", "addFamilySubmit");

/* ===== Delete modal: Enter confirms, Esc cancels ===== */
let deleteCtx = null;
function openDeleteModal(ctx){
  deleteCtx = ctx;
  const modal = byId("confirmDeleteModal");
  const detailsDiv = byId("deleteRowDetails");
  const dataDiv = byId("deleteRowData");
  
  // Get the row data to display
  let rowData = null;
  const { type, index } = ctx;
  
  if (type === "wages" && wagesRows[index]) {
    rowData = wagesRows[index];
  } else if (type === "reimb" && reimbRows[index]) {
    rowData = reimbRows[index];
  } else if (type === "reimbonly" && reimbOnlyRows[index]) {
    rowData = reimbOnlyRows[index];
  } else if (type === "home" && homeRows[index]) {
    rowData = homeRows[index];
  }
  
  // Display row details if we have data
  if (rowData && detailsDiv && dataDiv) {
    let detailsHTML = "";
    
    if (type === "wages") {
      detailsHTML = `
        <div><strong>Date:</strong> ${rowData.date || 'N/A'}</div>
        <div><strong>Hours:</strong> ${fmtAutoPlain(rowData.hours || 0)}</div>
        <div><strong>Amount:</strong> ${fmtAutoCurrency(rowData.amount || 0)}</div>
        <div><strong>Method:</strong> ${rowData.method || 'N/A'}</div>
        ${rowData.notes ? `<div><strong>Notes:</strong> ${rowData.notes}</div>` : ''}
      `;
    } else if (type === "reimbonly") {
      detailsHTML = `
        <div><strong>Date:</strong> ${rowData.date || 'N/A'}</div>
        <div><strong>Amount:</strong> ${fmtAutoCurrency(rowData.amount || 0)}</div>
        <div><strong>Method:</strong> ${rowData.method || 'N/A'}</div>
        ${rowData.notes ? `<div><strong>Notes:</strong> ${rowData.notes}</div>` : ''}
      `;
    } else if (type === "reimb" || type === "home") {
      detailsHTML = `
        <div><strong>Date:</strong> ${rowData.date || 'N/A'}</div>
        <div><strong>Store:</strong> ${rowData.vendor || 'N/A'}</div>
        <div><strong>Total:</strong> ${fmtAutoCurrency(rowData.expense || 0)}</div>
        <div><strong>Method:</strong> ${rowData.payMethod || 'N/A'}</div>
        ${rowData.cardLast4 ? `<div><strong>Last 4:</strong> ${rowData.cardLast4}</div>` : ''}
        ${rowData.notes ? `<div><strong>Notes:</strong> ${rowData.notes}</div>` : ''}
        ${rowData.receiptImg ? `<div><strong>Has Attachment:</strong> Yes</div>` : ''}
      `;
    }
    
    dataDiv.innerHTML = detailsHTML;
    detailsDiv.style.display = "block";
  } else {
    detailsDiv.style.display = "none";
  }
  
  modal.classList.add("open");
  const confirmBtn = byId("confirmDeleteBtn");
  confirmBtn?.setAttribute("autofocus","true");
  confirmBtn?.focus();
}
function closeDeleteModal(){
  byId("confirmDeleteModal").classList.remove("open");
  const detailsDiv = byId("deleteRowDetails");
  if (detailsDiv) detailsDiv.style.display = "none";
  deleteCtx = null;
}
window.addEventListener("DOMContentLoaded", () => {
  byId("closeConfirmDelete").onclick = closeDeleteModal;
  byId("cancelDeleteBtn").onclick = closeDeleteModal;

  byId("confirmDeleteBtn").onclick = async () => {
    if (!deleteCtx) return;
    const { type, index } = deleteCtx;

    let delId = null;
    if (type === "wages") delId = wagesRows[index]?.id;
    if (type === "reimb") delId = reimbRows[index]?.id;
    if (type === "reimbonly") delId = reimbOnlyRows[index]?.id;
    if (type === "home") delId = homeRows[index]?.id;

    if (type === "wages")      { wagesRows.splice(index, 1);      renderWages(); }
    if (type === "reimb")      { reimbRows.splice(index, 1);      renderReimb(); }
    if (type === "reimbonly")  { reimbOnlyRows.splice(index, 1);  renderReimbOnly(); }
    if (type === "home")       { homeRows.splice(index, 1);       renderHome(); }

    try {
      if (currentUser && delId) {
        const table = type === "wages" ? T_WAGES : type === "reimb" ? T_WORK : type === "reimbonly" ? T_REIMB : T_FAMILY;
        await deleteRow(table, delId);
      }
    } catch (e) { console.error("DB delete failed:", e); }

    saveAll();
    closeDeleteModal();
  };

  document.addEventListener("keydown", (e)=>{
    const isOpen = byId("confirmDeleteModal")?.classList.contains("open");
    if (!isOpen) return;
    if (e.key === "Enter"){ e.preventDefault(); byId("confirmDeleteBtn")?.click(); }
    if (e.key === "Escape"){ e.preventDefault(); closeDeleteModal(); }
  });
});

/* ===== Font ruler logic ===== */
const fsSlider = $("#fsSlider"), fsDown=$("#fsDown"), fsUp=$("#fsUp");
function applyScale(val){ document.documentElement.style.setProperty("--scale", (val/100).toString()); localStorage.setItem(SCALE_KEY, String(val)); }
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
fsSlider?.addEventListener("input", ()=> applyScale(+fsSlider.value));
fsDown?.addEventListener("click", ()=>{ fsSlider.value = clamp(+fsSlider.value-5, 60, 200); applyScale(+fsSlider.value); });
fsUp?.addEventListener("click", ()=>{ fsSlider.value = clamp(+fsSlider.value+5, 60, 200); applyScale(+fsSlider.value); });
const savedScale = +(localStorage.getItem(SCALE_KEY) || 70); if (byId("fsSlider")) { byId("fsSlider").value = clamp(savedScale,60,200); applyScale(+byId("fsSlider").value); }

/* ===== Click handlers (CRUD wired) ===== */
document.addEventListener("click",async (e)=>{
  const t=e.target;

  // Ignore clicks on select elements and their options to prevent dropdown interference on mobile
  if (t.tagName === 'SELECT' || t.tagName === 'OPTION' || t.closest('select')) {
    return;
  }

  // Wages
  if(t.id==="addWageRow") openWagesModal();
  if(t.id==="closeWagesModal") { $("#wagesModal").classList.remove("open"); removeBlurEffect(); }
  if(t.id==="addWagesRow"){
    if(!validate($("#wDate"))||!validate($("#wHours"))||!validate($("#wAmount"))||!validate($("#wMethod"))){return;}
    const amountNorm = normMoney($("#wAmount").value);
    if (amountNorm === null){ $("#wAmount").classList.add("mandatory-missing"); return; }
    $("#wAmount").value = fmtAutoPlain(amountNorm);

    await safeSubmit("wagesModal", "addWagesRow", async () => {
      const editIdx = $("#wagesModal").dataset.editIdx;
      const existingId = editIdx!=="" ? wagesRows[+editIdx]?.id : undefined;
      const obj={id: existingId, date:$("#wDate").value,hours:$("#wHours").value,amount:amountNorm,method:$("#wMethod").value||"Cash",notes:$("#wNotes").value};

      if (currentUser) {
        const saved = await upsertRow(T_WAGES, mapWageUIToDB(obj)); 
        obj.id = saved.id; 
      }

      const isNewRow = editIdx === "";
      if(editIdx!=="") {
        wagesRows[+editIdx]=obj;
        // Highlight edited row
        setTimeout(() => highlightNewRow("wagesBody", +editIdx), 100);
      } else {
        wagesRows.push(obj);
        // Highlight new row (last index)
        setTimeout(() => highlightNewRow("wagesBody", wagesRows.length - 1), 100);
      }
      renderWages(); saveAll(); 
      $("#wagesModal").classList.remove("open"); removeBlurEffect();
    });
  }

  // Work / Grocery
  if(t.id==="btnEnterReceipt") openReceiptModal();
  if(t.id==="closeReceiptModal") { $("#receiptModal").classList.remove("open"); removeBlurEffect(); }
  if(t.id==="attachReceiptBtn"){ byId("receiptFile").click(); }
  if(t.id==="addReceipt"){
    if(!validate($("#gDate"))||!validate($("#gVendor"))||!validate($("#gTotal"))||!validate($("#gPayMethod"))){return;}

    const amt = normMoney($("#gTotal").value);
    if (amt === null){ $("#gTotal").classList.add("mandatory-missing"); return; }
    $("#gTotal").value = fmtAutoPlain(amt);

    const method = $("#gPayMethod").value || "Credit Card";
    if(method.includes("Card") && !validate($("#gCardLast4"))){return;}

    await safeSubmit("receiptModal", "addReceipt", async () => {
      const editIdx = $("#receiptModal").dataset.editIdx;
      const existingId = editIdx!=="" ? reimbRows[+editIdx]?.id : undefined;

      let receiptUrl = pendingReceiptImage;
      if (currentUser && pendingReceiptImage) {
        receiptUrl = await uploadReceiptToStorage(pendingReceiptImage, "work"); 
      }

      const obj={ id: existingId,
                  date:$("#gDate").value,vendor:$("#gVendor").value,expense:amt,
                  payMethod:method,cardLast4:$("#gCardLast4").value,notes:$("#gNotes").value,
                  receiptImg: receiptUrl || null, receiptName: pendingReceiptName || ""};

      if (currentUser) {
        const saved = await upsertRow(T_WORK, mapWorkUIToDB(obj)); 
        obj.id = saved.id; 
      }

      const isNewRow = editIdx === "";
      if(editIdx!=="") {
        reimbRows[+editIdx]=obj;
        // Highlight edited row
        setTimeout(() => highlightNewRow("reimbBody", +editIdx), 100);
      } else {
        reimbRows.push(obj);
        // Highlight new row (last index)
        setTimeout(() => highlightNewRow("reimbBody", reimbRows.length - 1), 100);
      }
      pendingReceiptImage = null; pendingReceiptName = "";
      renderReimb(); saveAll(); 
      $("#receiptModal").classList.remove("open"); removeBlurEffect();
    });
  }

  // Reimbursement only
  if(t.id==="addReimbOnlyRow") openReimbOnlyModal();
  if(t.id==="closeReimbOnlyModal") { $("#reimbOnlyModal").classList.remove("open"); removeBlurEffect(); }
  if(t.id==="addReimbOnlyRowSubmit"){
    if(!validate($("#rDate"))||!validate($("#rAmount"))||!validate($("#rMethod"))){return;}
    const amt = normMoney($("#rAmount").value);
    if (amt === null){ $("#rAmount").classList.add("mandatory-missing"); return; }
    $("#rAmount").value = fmtAutoPlain(amt);

    await safeSubmit("reimbOnlyModal", "addReimbOnlyRowSubmit", async () => {
      const editIdx = $("#reimbOnlyModal").dataset.editIdx;
      const existingId = editIdx!=="" ? reimbOnlyRows[+editIdx]?.id : undefined;
      const obj={ id: existingId, date:$("#rDate").value,amount:amt,method:$("#rMethod").value||"Cash",notes:$("#rNotes").value };

      if (currentUser) {
        const saved = await upsertRow(T_REIMB, mapReimbOnlyUIToDB(obj)); 
        obj.id = saved.id; 
      }

      const isNewRow = editIdx === "";
      if(editIdx!=="") {
        reimbOnlyRows[+editIdx]=obj;
        // Highlight edited row
        setTimeout(() => highlightNewRow("reimbOnlyBody", +editIdx), 100);
      } else {
        reimbOnlyRows.push(obj);
        // Highlight new row (last index)
        setTimeout(() => highlightNewRow("reimbOnlyBody", reimbOnlyRows.length - 1), 100);
      }
      renderReimbOnly(); saveAll(); 
      $("#reimbOnlyModal").classList.remove("open"); removeBlurEffect();
    });
  }

  // Family
  if(t.id==="addFamilyRow") openFamilyModal();
  if(t.id==="closeFamilyModal") { $("#familyModal").classList.remove("open"); removeBlurEffect(); }
  if(t.id==="attachFamilyBtn"){ byId("familyFile").click(); }
  if(t.id==="addFamilySubmit"){
    if(!validate($("#fDate"))||!validate($("#fVendor"))||!validate($("#fTotal"))||!validate($("#fPayMethod"))){return;}

    const amt = normMoney($("#fTotal").value);
    if (amt === null){ $("#fTotal").classList.add("mandatory-missing"); return; }
    $("#fTotal").value = fmtAutoPlain(amt);

    const method = $("#fPayMethod").value || "Credit Card";
    if(method.includes("Card") && !validate($("#fCardLast4"))){return;}

    await safeSubmit("familyModal", "addFamilySubmit", async () => {
      const editIdx = $("#familyModal").dataset.editIdx;
      const existingId = editIdx!=="" ? homeRows[+editIdx]?.id : undefined;

      let receiptUrl = pendingFamilyImage;
      if (currentUser && pendingFamilyImage) {
        receiptUrl = await uploadReceiptToStorage(pendingFamilyImage, "family"); 
      }

      const obj={ id: existingId,
                  date:$("#fDate").value,vendor:$("#fVendor").value,expense:amt,
                  payMethod:method,cardLast4:$("#fCardLast4").value,notes:$("#fNotes").value,
                  receiptImg: receiptUrl || null, receiptName: pendingFamilyName || "" };

      if (currentUser) {
        const saved = await upsertRow(T_FAMILY, mapFamilyUIToDB(obj)); 
        obj.id = saved.id; 
      }

      const isNewRow = editIdx === "";
      if(editIdx!=="") {
        homeRows[+editIdx]=obj;
        // Highlight edited row
        setTimeout(() => highlightNewRow("homeBody", +editIdx), 100);
      } else {
        homeRows.push(obj);
        // Highlight new row (last index)
        setTimeout(() => highlightNewRow("homeBody", homeRows.length - 1), 100);
      }
      pendingFamilyImage = null; pendingFamilyName = "";
      renderHome(); saveAll(); 
      $("#familyModal").classList.remove("open"); removeBlurEffect();
    });
  }

  // Edit via modals
  if(t.closest(".edit-wages")){ const b=t.closest(".edit-wages"); openWagesModal(+b.dataset.i); }
  if(t.closest(".edit-reimb")){ const b=t.closest(".edit-reimb"); openReceiptModal(+b.dataset.i); }
  if(t.closest(".edit-home")) { const b=t.closest(".edit-home");  openFamilyModal(+b.dataset.i); }
  if(t.closest(".edit-reimbonly")){ const b=t.closest(".edit-reimbonly"); openReimbOnlyModal(+b.dataset.i); }

  // Delete (custom modal)
  const delBtn = t.closest("button[data-act='del']");
  if (delBtn) openDeleteModal({ type: delBtn.dataset.type, index: +delBtn.dataset.i });

  // Attachment: view/add (table button)
  if(t.closest(".view-attachment")){
    const btn = t.closest(".view-attachment");
    const i = +btn.dataset.i;
    const type = btn.dataset.type || "reimb";
    const srcRow = type==="home" ? homeRows[i] : reimbRows[i];
    if(srcRow && srcRow.receiptImg){
      await displayReceiptImage(srcRow.receiptImg);
      $("#receiptPreviewModal").classList.add("open");
      addBlurEffect();
    }
  }
  if(t.closest(".add-attachment")){
    const btn = t.closest(".add-attachment");
    const i = +btn.dataset.i;
    const type = btn.dataset.type || "reimb";
    const fileInput = document.createElement("input");
    fileInput.type="file"; fileInput.accept="image/*";
    fileInput.onchange=async e=>{
      const f=e.target.files?.[0];
      if(f){
        let urlOrBase64 = await uploadReceiptToStorage(
          f,
          type === "home" ? "family" : "work"
        );
        if(type==="home"){
          homeRows[i].receiptImg = urlOrBase64;
          homeRows[i].receiptName = f.name;
          // Only DB write if row already has an id (prevents 428C9)
          if (currentUser && homeRows[i]?.id) {
            try { await upsertRow(T_FAMILY, mapFamilyUIToDB(homeRows[i])); } catch(e){ console.error(e); }
          }
          saveAll(); renderHome();
        }else{
          reimbRows[i].receiptImg = urlOrBase64;
          reimbRows[i].receiptName = f.name;
          if (currentUser && reimbRows[i]?.id) {
            try { await upsertRow(T_WORK, mapWorkUIToDB(reimbRows[i])); } catch(e){ console.error(e); }
          }
          saveAll(); renderReimb();
        }
      }
    };
    fileInput.click();
  }

  // Close preview modal (button or clicking backdrop)
  if (t.id === "closePreviewModal" || (t.id === "receiptPreviewModal" && t.classList.contains("open"))) {
    byId("receiptPreviewModal").classList.remove("open");
    removeBlurEffect();
  }
});

/* ===== NEW: Modal file input change listeners to make Upload buttons work ===== */
byId("receiptFile")?.addEventListener("change", async (e) => {
  const f = e.target.files?.[0];
  if (!f) return;
  let urlOrBase64 = await uploadReceiptToStorage(f, "work");
  pendingReceiptImage = urlOrBase64;
  pendingReceiptName  = f.name;
  byId("attachReceiptBtn")?.replaceChildren(`${langStrings[currentLang].upload} (${pendingReceiptName})`);
});
byId("familyFile")?.addEventListener("change", async (e) => {
  const f = e.target.files?.[0];
  if (!f) return;
  let urlOrBase64 = await uploadReceiptToStorage(f, "family");
  pendingFamilyImage = urlOrBase64;
  pendingFamilyName  = f.name;
  byId("attachFamilyBtn")?.replaceChildren(`${langStrings[currentLang].upload} (${pendingFamilyName})`);
});

/* ===== Row click to open attachment (if present) ===== */
function rowClickOpener(tbodyId, rowsArr, type){
  const tb = byId(tbodyId);
  if (!tb) return;
  tb.addEventListener("click",async (e)=>{
    const target = e.target;
    if (target.closest("button") || target.closest(".icon-btn") || target.tagName === "SVG" || target.tagName === "PATH") return;
    const tr = target.closest("tr");
    if (!tr) return;
    const i = +tr.dataset.i;
    const row = rowsArr[i];
    if (row && row.receiptImg){
      await displayReceiptImage(row.receiptImg);
      $("#receiptPreviewModal").classList.add("open");
      addBlurEffect();
    }
  });
}
rowClickOpener("reimbBody", reimbRows, "reimb");

async function enhancedRowClickFallback(rowsArr, i){
  const row = rowsArr[i];
  if (row && row.receiptImg){
    await displayReceiptImage(row.receiptImg);
    $("#receiptPreviewModal").classList.add("open");
    addBlurEffect();
    return true;
  }
  return false;
}
// Rebind click handlers to be more defensive and ensure preview on row click
(function(){
  function bind(defTbodyId, arr){
    const tb = byId(defTbodyId);
    if (!tb) return;
    tb.addEventListener("click",async (e)=>{
      const target = e.target;
      if (target.closest("button") || target.closest(".icon-btn") || target.tagName === "SVG" || target.tagName === "PATH") return;
      const tr = target.closest("tr");
      if (!tr) return;
      const i = +tr.dataset.i;
      const has = tr.dataset.hasAttachment === "true";
      if (has){
        if (!(await enhancedRowClickFallback(arr, i))){
          // Fallback: try to read from row element if an inline src was ever placed (future-proof)
          const src = tr.getAttribute("data-receipt-src");
          if (src){
            await displayReceiptImage(src);
            $("#receiptPreviewModal").classList.add("open");
            addBlurEffect();
          }
        }
      }
    });
  }
  bind("reimbBody", reimbRows);
  bind("homeBody",  homeRows);
})();

rowClickOpener("homeBody", homeRows, "home");

// Add event listeners to prevent modal backdrop closing
document.addEventListener("DOMContentLoaded", () => {
  const modals = ["wagesModal", "receiptModal", "reimbOnlyModal", "familyModal"];
  
  modals.forEach(modalId => {
    const modal = byId(modalId);
    if (modal) {
      modal.addEventListener("click", (e) => {
        // Only prevent closing if clicking on the modal backdrop itself, not its children
        if (e.target === modal) {
          e.preventDefault();
          e.stopPropagation();
        }
      });
    }
  });
});

// Disable backdrop closing for receipt preview modal too
byId("receiptPreviewModal")?.addEventListener("click",(e)=>{
  // Only prevent closing if clicking on the modal backdrop itself
  if (e.target.id === "receiptPreviewModal") {
    e.preventDefault();
    e.stopPropagation();
  }
});
// ESC key closes preview
document.addEventListener("keydown",(e)=>{
  if (e.key === "Escape" && byId("receiptPreviewModal")?.classList.contains("open")) {
    byId("receiptPreviewModal").classList.remove("open");
    removeBlurEffect();
  }
});

/* ===== Open/Close Modals ===== */
function openWagesModal(editIdx = null){
  $("#wagesModal").classList.add("open");
  addBlurEffect();
  const seed = editIdx!=null ? wagesRows[editIdx] : {};
  $("#wDate").value   = seed?.date   || today();
  $("#wHours").value  = seed?.hours  ?? "";
  $("#wAmount").value = seed?.amount ? fmtAutoPlain(seed.amount) : "";
  $("#wMethod").value = seed?.method || "Cash";
  $("#wNotes").value  = seed?.notes  || "";
  $("#wagesModal").dataset.editIdx = editIdx!=null ? editIdx : "";
}

function openReceiptModal(editIdx = null){
  $("#receiptModal").classList.add("open");
  addBlurEffect();
  const seed = editIdx!=null ? reimbRows[editIdx] : {};
  $("#gDate").value       = seed?.date      || today();
  $("#gVendor").value     = seed?.vendor    || "";
  $("#gTotal").value      = seed?.expense ? fmtAutoPlain(seed.expense) : "";
  $("#gPayMethod").value  = seed?.payMethod || "Credit Card";
  $("#gCardLast4").value  = seed?.cardLast4 || "";
  $("#gNotes").value      = seed?.notes     || "";
  $("#receiptModal").dataset.editIdx = editIdx!=null ? editIdx : "";

  pendingReceiptImage = seed?.receiptImg || null;
  pendingReceiptName  = seed?.receiptName || "";
  const label = pendingReceiptName ? `${langStrings[currentLang].upload} (${pendingReceiptName})`
                                   : langStrings[currentLang].upload;
  byId("attachReceiptBtn")?.replaceChildren(label);
}

function openFamilyModal(editIdx = null){
  $("#familyModal").classList.add("open");
  addBlurEffect();
  const seed = editIdx!=null ? homeRows[editIdx] : {};
  $("#fDate").value      = seed?.date      || today();
  $("#fVendor").value    = seed?.vendor    || "";
  $("#fTotal").value     = seed?.expense ? fmtAutoPlain(seed.expense) : "";
  $("#fPayMethod").value = seed?.payMethod || "Credit Card";
  $("#fCardLast4").value  = seed?.cardLast4 || "";
  $("#fNotes").value     = seed?.notes     || "";
  $("#familyModal").dataset.editIdx = editIdx!=null ? editIdx : "";

  pendingFamilyImage = seed?.receiptImg || null;
  pendingFamilyName  = seed?.receiptName || "";
  const label = pendingFamilyName ? `${langStrings[currentLang].upload} (${pendingFamilyName})`
                                  : langStrings[currentLang].upload;
  byId("attachFamilyBtn")?.replaceChildren(label);
}


function openReimbOnlyModal(editIdx = null){
  $("#reimbOnlyModal").classList.add("open");
  addBlurEffect();
  const seed = editIdx!=null ? reimbOnlyRows[editIdx] : {};
  $("#rDate").value   = seed?.date   || today();
  $("#rAmount").value = seed?.amount ? fmtAutoPlain(seed.amount) : "";
  $("#rMethod").value = seed?.method || "Cash";
  $("#rNotes").value  = seed?.notes  || "";
  $("#reimbOnlyModal").dataset.editIdx = editIdx!=null ? editIdx : "";
}

/* ===== Blur Effect Helpers ===== */
function addBlurEffect() {
  const header = document.querySelector('header');
  const container = document.querySelector('.container');
  if (header) header.style.filter = 'blur(2px)';
  if (container) container.style.filter = 'blur(2px)';
}

function removeBlurEffect() {
  const header = document.querySelector('header');
  const container = document.querySelector('.container');
  if (header) header.style.filter = '';
  if (container) container.style.filter = '';
}

// --- Robust Enter-to-submit for Reimbursement modal ---
document.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    const m = byId("reimbOnlyModal");
    if (m && m.classList.contains("open")) {
      e.preventDefault();
      byId("addReimbOnlyRowSubmit")?.click();
    }
  }
});

/* ===== OCR helpers ===== */
async function ocrFile(file){
  if(!window.Tesseract){ return ""; }
  const {data:{text}}=await Tesseract.recognize(file,'eng');
  return text||"";
}
function parseReceiptText(txt){
  const moneyPattern = /(?:\$)?\d+(?:\.\d{2})?/g;
  const lines=txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  let date="",store="",total="";
  const dateRxs=[/\b(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})\b/,/\b(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})\b/];
  for(const rx of dateRxs){const m=txt.match(rx); if(m){date=m[0];break;}}
  store = lines.find(s=>!s.match(/total/i)&&s.replace(/[^a-z]/ig,"").length>1) || "";
  for(const l of lines){if(/\btotal\b/i.test(l)){const m=l.match(moneyPattern); if(m){total=m[m.length-1].replace(/[^0-9.]/g,""); break;}}}
  if(!total){
    const amts=[...txt.matchAll(moneyPattern)].map(m=>m[0].replace(/[^0-9.]/g,""));
    if(amts.length) total = amts.map(Number).sort((a,b)=>b-a)[0].toFixed(2);
  }
  return {date,store,total};
}
function fileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = ()=> resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

/* ===== Clean attachment URL to remove trailing '=m' or query ===== */
function cleanAttachmentUrl(u){
  if (!u || typeof u !== "string") return u;
  if (u.startsWith("data:")) return u;
  let url = u.split("#")[0];
  url = url.replace(/=m\d*$/i, "").replace(/=s\d+$/i, "");
  url = url.split("?")[0];
  return url;
}

/* ===== Migrate legacy image paths ===== */
async function migrateLegacyImagePaths() {
  if (!currentUser) return;
  
  // Check if migration has already been run for this user
  const migrationKey = `migration_completed_${currentUser.id}`;
  if (localStorage.getItem(migrationKey)) {
    console.log("Legacy image path migration already completed");
    return;
  }
  
  try {
    console.log("Starting migration of legacy image paths...");
    
    // Get all records that might have old image paths
    const tables = ['work_expense', 'family_expense'];
    let totalUpdated = 0;
    
    for (const table of tables) {
      const { data: records, error } = await supabase
        .from(table)
        .select('id, receipt_img')
        .eq('user_id', currentUser.id)
        .not('receipt_img', 'is', null)
        .like('receipt_img', '%/receipts/shared/%');
      
      if (error) {
        console.warn(`Error fetching ${table} records:`, error);
        continue;
      }
      
      if (records && records.length > 0) {
        console.log(`Found ${records.length} records in ${table} with legacy paths`);
        
        for (const record of records) {
          if (record.receipt_img && record.receipt_img.includes('/receipts/shared/')) {
            // Convert old path to new path
            const newPath = record.receipt_img.replace('/receipts/shared/', `/receipts/${currentUser.id}/`);
            
            // Update the database record
            const { error: updateError } = await supabase
              .from(table)
              .update({ receipt_img: newPath })
              .eq('id', record.id);
            
            if (updateError) {
              console.warn(`Failed to update ${table} record:`, updateError);
            } else {
              console.log(`Updated ${table} record path`);
              totalUpdated++;
            }
          }
        }
      }
    }
    
    console.log(`Legacy image path migration completed. Updated ${totalUpdated} records.`);
    
    // Mark migration as completed for this user
    localStorage.setItem(migrationKey, 'true');
    
  } catch (e) {
    console.error("Error during legacy image path migration:", e);
  }
}

/* ===== Get authenticated storage URL for receipt images ===== */
async function getAuthenticatedImageUrl(receiptImg) {
  if (!receiptImg || typeof receiptImg !== "string") return receiptImg;
  if (receiptImg.startsWith("data:")) return receiptImg;
  
  // Handle both old and new path formats
  if (receiptImg.includes('supabase') && receiptImg.includes('/storage/v1/object/public/receipts/') && currentUser) {
    try {
      // Extract the path from the public URL
      const pathMatch = receiptImg.match(/\/storage\/v1\/object\/public\/receipts\/(.+)$/);
      if (pathMatch) {
        let filePath = pathMatch[1];
        
        // If it's an old path (starts with 'shared/'), convert to new user-specific path
        if (filePath.startsWith('shared/')) {
          filePath = filePath.replace('shared/', `${currentUser.id}/`);
        }
        
        // Try to get signed URL for the (potentially converted) path
        const { data, error } = await supabase.storage
          .from('receipts')
          .createSignedUrl(filePath, 3600); // 1 hour expiry
        
        if (!error && data?.signedUrl) {
          console.log("Successfully got signed URL for:", filePath);
          return data.signedUrl;
        } else {
          console.warn("Failed to get signed URL:", error?.message);
          // Fall back to trying the original path structure if conversion failed
          if (filePath !== pathMatch[1]) {
            const { data: fallbackData, error: fallbackError } = await supabase.storage
              .from('receipts')
              .createSignedUrl(pathMatch[1], 3600);
            
            if (!fallbackError && fallbackData?.signedUrl) {
              console.log("Fallback signed URL successful for:", pathMatch[1]);
              return fallbackData.signedUrl;
            }
          }
        }
      }
    } catch (e) {
      console.warn("Failed to get signed URL, using public URL:", e);
    }
  }
  
  return cleanAttachmentUrl(receiptImg);
}

/* ===== Enhanced image display with error handling ===== */
async function displayReceiptImage(receiptImg) {
  const previewImg = byId("previewImg");
  if (!previewImg) return;
  
  try {
    console.log("Attempting to load image:", receiptImg);
    const imageUrl = await getAuthenticatedImageUrl(receiptImg);
    
    // Add error handling for image load
    previewImg.onerror = () => {
      console.warn("Failed to load receipt image:", imageUrl);
      previewImg.src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDIwMCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMTUwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik04NS41IDc1QzQ3LjUgNzUgMTcuNSA0NSAxNy41IDQ1SDE3NS41QzE3NS41IDQ1IDE0NS41IDc1IDEwNy41IDc1SDE3NS41VjEyMEgxNy41Vjc1SDg1LjVaIiBmaWxsPSIjRDFENTk5Ii8+CjxjaXJjbGUgY3g9IjEwMCIgY3k9IjYwIiByPSIxNSIgZmlsbD0iI0Q5RDlEOSIvPgo8dGV4dCB4PSI1MCUiIHk9IjkwIiBmaWxsPSIjNjc3Mjg5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTIiPkltYWdlIFVuYXZhaWxhYmxlPC90ZXh0Pgo8L3N2Zz4K";
      previewImg.alt = "Receipt image unavailable - please check storage configuration";
    };
    
    previewImg.onload = () => {
      console.log("Receipt image loaded successfully");
    };
    
    previewImg.src = imageUrl;
  } catch (e) {
    console.error("Error displaying receipt image:", e);
    previewImg.src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDIwMCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMTUwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik04NS41IDc1QzQ3LjUgNzUgMTcuNSA0NSAxNy41IDQ1SDE3NS41QzE3NS41IDQ1IDE0NS41IDc1IDEwNy41IDc1SDE3NS41VjEyMEgxNy41Vjc1SDg1LjVaIiBmaWxsPSIjRDFENTk5Ii8+CjxjaXJjbGUgY3g9IjEwMCIgY3k9IjYwIiByPSIxNSIgZmlsbD0iI0Q5RDlEOSIvPgo8dGV4dCB4PSI1MCUiIHk9IjkwIiBmaWxsPSIjNjc3Mjg5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTIiPkltYWdlIFVuYXZhaWxhYmxlPC90ZXh0Pgo8L3N2Zz4K";
    showErrorNotification("Failed to load receipt image");
  }
}

/* ===== Init ===== */
document.getElementById("langSwitch").value="en";
setLang("en");
loadAll();

// Toolbar buttons
document.getElementById("exportExcel").addEventListener("click", exportExcel);
document.getElementById("importBtn").addEventListener("click", ()=> byId("importExcel").click());
document.getElementById("importExcel").addEventListener("change", e=>{
  const f = e.target.files?.[0]; if(f) importExcel(f);
});

(async () => {
  console.log("🚀 Money Tracker v3.7 - Application Starting");
  console.log("📅 Build Date:", new Date().toISOString());
  console.log("🔧 Features: Enhanced RLS Security, User Data Isolation, Image Migration, Enhanced UI, Optimized Base64 with Compression");
  
  await getSessionUser();
  console.log("🔐 Authentication check completed");
  
  toggleUI();
  if (currentUser) await loadFromDBAndRender();
  preflightStorage();
  
  console.log("✅ Money Tracker v3.7 - Application Ready");
})();
</script>

<!-- Delete confirmation modal -->
<div class="modal" id="confirmDeleteModal" role="dialog" aria-modal="true">
  <div class="panel delete-modal-panel">
    <div class="card-header">
      <div class="card-title"><strong id="confirmDeleteTitle">Confirm Delete</strong></div>
      <div class="actions"><button class="btn warn sm" id="closeConfirmDelete">✕</button></div>
    </div>
    <div class="delete-modal-content">
      <p id="confirmDeleteMsg">Are you sure you want to delete this row?</p>
      <div id="deleteRowDetails" class="delete-row-details">
        <div id="deleteRowData" class="delete-row-data"></div>
      </div>
      <div class="delete-modal-actions">
        <button class="btn" id="cancelDeleteBtn">Cancel</button>
        <button class="btn warn" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>
</div>

</body>
</html>